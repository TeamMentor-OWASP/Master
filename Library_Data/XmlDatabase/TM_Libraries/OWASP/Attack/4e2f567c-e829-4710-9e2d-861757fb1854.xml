<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="4e2f567c-e829-4710-9e2d-861757fb1854" Author="" Category="Input and Data Validation" Priority="1" Rule_Type="Attack" Status="" Technology=" Any" title="SQL Injection Attack" Topic="Security" phase="Any" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;br&gt;&lt;br&gt;&lt;h1&gt;Applies To&lt;/h1&gt;&lt;p&gt;Any application that interacts with a SQL database.&lt;/p&gt;&lt;h1&gt;Description&lt;/h1&gt;&lt;p&gt;A SQL injection attack exploits vulnerabilities in input validation to run arbitrary commands in the database. It can occur when your application uses input to construct dynamic SQL statements to access the database. It can also occur if your code uses stored procedures that are passed strings that contain raw user input. Using the SQL injection attack, an attacker can execute arbitrary commands in your database, with all the privileges granted to the process being attacked. The issue is magnified if the application uses an over-privileged account to connect to the database. In this instance it is possible to use the database server to run operating system commands and potentially compromise other servers, in addition to being able to retrieve, manipulate, and destroy data. &lt;/p&gt;&lt;h1&gt;Impact&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Confidentiality&lt;/strong&gt;: Since SQL databases generally hold sensitive data, loss of confidentiality is a frequent problem with SQL injection vulnerabilities. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Authentication&lt;/strong&gt;: If poor SQL commands are used to check user names and passwords, it may be possible to connect to a system as another user with no previous knowledge of the password. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Authorization&lt;/strong&gt;: If authorization information is held in an SQL database, it may be possible to change this information through the successful exploitation of an SQL injection vulnerability. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Integrity&lt;/strong&gt;: Just as it may be possible to read sensitive information, it is also possible to make changes or even delete this information with an SQL injection attack. &lt;/li&gt;&lt;/ul&gt;&lt;p&gt;The capabilities of an attacker are constrained by the permissions of the account you use to connect to the database. For this reason, your application should connect to the database with an account that has the minimum necessary set of privileges. &lt;/p&gt;&lt;h1&gt;Vulnerabilities&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Weak input validation. &lt;/li&gt;&lt;li&gt;Dynamic construction of SQL statements without the use of type-safe parameters. &lt;/li&gt;&lt;li&gt;Use of over-privileged database logins. &lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Countermeasures&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Constrain input.&lt;/strong&gt; Use vigorous white-list style checking and type checking on any user input that may be used in an SQL command. Rather than escape meta-characters, it is safest to avoid adding them to your white-list. Later use of data that has been entered in the database may neglect to escape meta-characters before use. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Use Parameterized SQL statements and stored procedures. &lt;/strong&gt;Parameterized SQL statements will process characters that have special meaning to SQL (like single quote) without negative security implications. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Use escaping routines&lt;/strong&gt;. If you cannot use parameters and must use dynamic SQL, use escaping routines to handle special characters that have meaning to the database. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Use an account with limited permissions in the database&lt;/strong&gt;. Ideally the account should only have execute permissions on the set of stored procedures that your application needs to use and it should have no direct table access. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Do not echo database errors&lt;/strong&gt;. Catch exceptions on the server and return generic error messages to the client.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Example&lt;/h1&gt;&lt;p&gt;While it is easier and more reliable to fix SQL injection by parameterization, it can be fixed without it. Suppose we have a PHP/MySQL application that has two tables: users and products. Each row in the USER table contains the users ID, name, password, credit card number, and address. Similarly, the product table has a column for the product ID, description, and price. The application contains a SQL Query that retrieves the description of a product given its ID.&lt;/p&gt;&lt;pre&gt;$query = "SELECT description FROM products WHERE product_id = " + $prod_id + ";";$result = mysql_query($query);&lt;/pre&gt;&lt;p&gt;So, if the value of $prod_id is 5 then $query reads:&lt;/p&gt;&lt;pre&gt;SELECT description FROM products WHERE product_id = 5;&lt;/pre&gt;&lt;p&gt;An attacker enters the following string where the application asks for the product ID (expecting a number):&lt;/p&gt;&lt;pre&gt;5; SELECT * from users&lt;/pre&gt;&lt;p&gt;Now $query has the following value which is a perfectly legitimate SQL query:&lt;/p&gt;&lt;pre&gt;SELECT description FROM products WHERE product_id = 5; SELECT * from users;&lt;/pre&gt;&lt;p&gt;The query is executed and the product description is returned along with every row in the User table and the attacker has all of the confidential information from the database. &lt;/p&gt;&lt;p&gt;Every situation and programming language presents its own challenge but in this case we can escape the character sequence so that MySQL interprets the entire user-supplied string as part of the WHERE clause. The PHP function to do this is mysql_real_escape_string().&lt;/p&gt;&lt;pre&gt;$query = "SELECT description FROM products WHERE product_id = " +  mysql_real_escape_string($prod_id) + ";";$result = mysql_query($query);&lt;/pre&gt;&lt;p&gt;The value of $query should now look like the following:&lt;/p&gt;&lt;pre&gt;SELECT description FROM products WHERE product_id = \'5; SELECT * from users\';&lt;/pre&gt;&lt;p&gt;All potentially dangerous characters in the string provided by the user have been escaped and it can be safely put in a MySQL query.&lt;/p&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="http://en.wikipedia.org/wiki/SQL_injection"&gt;http://en.wikipedia.org/wiki/SQL_injection&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="http://www.php.net/manual/en/security.database.sql-injection.php"&gt;http://www.php.net/manual/en/security.database.sql-injection.php&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="http://msdn2.microsoft.com/en-us/library/ms998271.aspx"&gt;http://msdn2.microsoft.com/en-us/library/ms998271.aspx&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="http://www.unixwiz.net/techtips/sql-injection.html"&gt;http://www.unixwiz.net/techtips/sql-injection.html&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:8515588C-661A-4962-853F-6CD6ABCD8CF6"&gt;Attack: Server-Side Code Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:4572037A-2166-4AD1-8E73-D623E468A7B9"&gt;Attack: Information Disclosure Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:1CCC080F-9290-4BD2-8A2C-6A45F59727B0"&gt;Attack: Xpath-XQuery Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:092BC54D-5A7F-451F-9EB1-AB0A1F1708C0"&gt;Attack: LDAP Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:044B9F0A-6A95-442C-BF24-3F890D0B10EF"&gt;Attack: Client-side Validation Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:ADE80907-B490-4FD3-81A8-826117E25662"&gt;Guideline: Use Stored Procedures &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:42F599F0-D1D6-4F25-9CC2-D5473F19113F"&gt;Guideline: Validate All Data Passed Between Native and Java Code &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:AEFDE06D-281E-493B-85FE-BAA586684857"&gt;Guideline: Allow Only Trusted Hosts to Connect to Database Server &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:9DF701E2-7929-4533-9DC3-368AAC4E553D"&gt;Guideline: Use Type Safe SQL Parameters When Constructing SQL Queries &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:0FFC3880-7F2B-47A5-BC54-F9BD39117BDD"&gt;Guideline: Validate Input from All Sources &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:DA8CCFC9-F04F-4913-B05E-F574D3E4A559"&gt;Guideline: Validate Input for Length, Range, Format, and Type &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:81491E66-67B7-49F3-BDA6-4B4C9245C702"&gt;Guideline: Validate All Input Passed to Database &lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>