<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="dfdb2801-2abe-44d3-93ff-9f6254197978" Author="" Category="Input and Data Validation" Priority="1" Rule_Type="Attack" Status="" Technology=" Any" title="Xpath-XQuery Attack" Topic="Security" phase="Any" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;br&gt;&lt;br&gt;&lt;h1&gt;Applies To&lt;/h1&gt;&lt;p&gt;Any application that can manipulate XML documents through Xpath/XQuery &lt;/p&gt;&lt;h1&gt;Description&lt;/h1&gt;&lt;p&gt;An Xpath/XQuery attack exploits vulnerabilities in input validation to run arbitrary commands in XML databases. This attack works in much the same way as a SQL injection attack but with an XML target instead of a SQL target. This attack can occur when your application uses input directly from a user to construct an Xpath/XQuery statement to access XML tables. Using the Xpath/XQuery attack the attacker can execute arbitrary Xpath/XQuery statements on an XML database. This attack is often more damaging than a SQL injection attack as permissions are not enforced and the attacker’s query can access every part of the XML document. With an Xpath/XQuery attack it is possible to retrieve, manipulate, and destroy any data stored in the XML document.&lt;/p&gt;&lt;h1&gt;Impact&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Confidentiality:&lt;/strong&gt; Since XML generally holds sensitive data, loss of confidentiality is a frequent problem with XPath/XQuery injection vulnerabilities. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Authentication:&lt;/strong&gt; If poor XPath/XQuery commands are used to check user names and passwords, it may be possible to connect to a system as another user with no previous knowledge of the password. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Authorization:&lt;/strong&gt; If authorization information is held in an XML document, it may be possible to change this information through the successful exploitation of an XPath/XQuery injection vulnerability. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Integrity:&lt;/strong&gt; Just as it may be possible to read sensitive information, it is also possible to make changes or even delete this information with an XPath/XQuery injection attack. &lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Vulnerabilities&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Weak input validation. &lt;/li&gt;&lt;li&gt;Generating XPath expressions by dynamically concatenating strings with user supplied data. &lt;/li&gt;&lt;li&gt;Failure to escape single quotes, double quotes, and other potentially dangerous characters.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Countermeasures&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Constrain input.&lt;/strong&gt; Use vigorous white-list style checking on any user input that may be used as part of an XQuery command. This will also help prevent meta characters from being added to your stored data set which will be used again. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Use parameterized and precompiled XPath expressions in your XQuery instead of concatinating strings with user input.&lt;/strong&gt; Parameterized Xpath statements will accept characters that have special meaning to Xpath (like single quote) without problems because they are strongly typed. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Use escaping routines.&lt;/strong&gt; If you cannot use parameters and must generate XPath expressions dynamically, use escaping routines to handle special characters that have meaning to the database. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Do not echo XQuery errors.&lt;/strong&gt; Catch any exceptions on the server and return generic error messages to the client.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Example&lt;/h1&gt;&lt;p&gt;Consider the following XML file, being used by an application to log users into the application&lt;/p&gt;&lt;pre&gt;&amp;lt;?xml version="1.0" encoding="ISO-8859-1"?&amp;gt; &amp;lt;users&amp;gt;    &amp;lt;user&amp;gt;       &amp;lt;username&amp;gt;admin&amp;lt;/username&amp;gt;       &amp;lt;password&amp;gt;8af2&amp;amp;&amp;lt;/password&amp;gt;       &amp;lt;account&amp;gt;admin&amp;lt;/account&amp;gt;    &amp;lt;/user&amp;gt;    &amp;lt;user&amp;gt;       &amp;lt;username&amp;gt;user1&amp;lt;/username&amp;gt;       &amp;lt;password&amp;gt;password&amp;lt;/password&amp;gt;       &amp;lt;account&amp;gt;guest&amp;lt;/account&amp;gt;    &amp;lt;/user&amp;gt;    &amp;lt;user&amp;gt;       &amp;lt;username&amp;gt;user2&amp;lt;/username&amp;gt;       &amp;lt;password&amp;gt;1234&amp;lt;/password&amp;gt;       &amp;lt;account&amp;gt;guest&amp;lt;/account&amp;gt;    &amp;lt;/user&amp;gt; &amp;lt;/users&amp;gt;&lt;/pre&gt;&lt;p&gt;A developer could use the following Xpath command to return all the users with the username&lt;/p&gt;&lt;pre&gt;‘user1’ and password ‘password’string(//user[username/text()='user1'        and password/text()='password']/account/text())&lt;/pre&gt;&lt;p&gt;However, without proper input validation the attacker could easily input a logic statement to manipulate the output of the query. An attacker could provide the following string to the Xpath statement above.&lt;/p&gt;&lt;pre&gt;Username: user1Password: ' or '1' = '1&lt;/pre&gt;&lt;p&gt;This will change the Xpath statement to look like this:&lt;/p&gt;&lt;pre&gt;string(//user[username/text()='user1' and password/text()=''        or '1' = '1']/account/text())&lt;/pre&gt;&lt;p&gt;The password portion of the query will always resolve to true which means that the application will authenticate the attacker as user1 even though no password was provided.&lt;/p&gt;&lt;p&gt;A good way to fix this example is to use a parameterized query. The idea here is to create a precompiled query that gets values from parameters instead of dynamically creating an XPath expression by concatination at run time. Let $username and $password be string variables that hold the users input. Then construct a query in the following way:&lt;/p&gt;&lt;pre&gt;"//user[user[username/text()=$username and password/text()=$password]"&lt;/pre&gt;&lt;p&gt;If you are using .NET see the Additional Resources below for another example of how this works.&lt;/p&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="http://www.tkachenko.com/blog/archives/000385.html"&gt;http://www.tkachenko.com/blog/archives/000385.html&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="http://www.owasp.org/index.php/XML_Injection"&gt;http://www.owasp.org/index.php/XML_Injection&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="http://palisade.plynt.com/issues/2005Jul/xpath-injection/index.php"&gt;http://palisade.plynt.com/issues/2005Jul/xpath-injection/index.php&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="http://secureitalliance.org/blogs/watchfire/archive/2006/02/10/660.aspx"&gt;http://secureitalliance.org/blogs/watchfire/archive/2006/02/10/660.aspx&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:208A476B-ABCA-4630-9D02-746C52F47017"&gt;Attack: XML Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:1D4FA7AF-33F0-40D9-9665-A31DBF3D7764"&gt;Attack: SQL Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:4572037A-2166-4AD1-8E73-D623E468A7B9"&gt;Attack: Information Disclosure Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:8515588C-661A-4962-853F-6CD6ABCD8CF6"&gt;Attack: Server-Side Code Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:092BC54D-5A7F-451F-9EB1-AB0A1F1708C0"&gt;Attack: LDAP Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:DD60FFDF-904D-45A8-8278-F3E8CEBA911F"&gt;Guideline: Do Not Rely on Request Validation &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:42F599F0-D1D6-4F25-9CC2-D5473F19113F"&gt;Guideline: Validate All Data Passed Between Native and Java Code &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:0FFC3880-7F2B-47A5-BC54-F9BD39117BDD"&gt;Guideline: Validate Input from All Sources &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:DA8CCFC9-F04F-4913-B05E-F574D3E4A559"&gt;Guideline: Validate Input for Length, Range, Format, and Type &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:D6593992-DC9E-42C5-9E98-30E8EF075B93"&gt;Guideline: Do Not Rely on Client-Side Validation &lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>