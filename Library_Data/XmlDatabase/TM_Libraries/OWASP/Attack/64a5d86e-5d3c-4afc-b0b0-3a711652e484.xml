<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="64a5d86e-5d3c-4afc-b0b0-3a711652e484" Author="" Category="Encryption" Priority="2" Rule_Type="Attack" Status="" Technology=" Any" title="Weak Keystore Protection Attack" Topic="Security" phase="Any" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;br&gt;&lt;br&gt;&lt;h1&gt;Applies To&lt;/h1&gt;&lt;p&gt;Applications using cryptography.&lt;/p&gt;&lt;h1&gt;Description&lt;/h1&gt;&lt;p&gt;A keystore is a secure location on disk or in memory that can be used to store cryptographic keys or trusted certificates. Typically, these keys are bound to the machine and only available to a certain application. If the application uses a weak keystore, it may be possible to recover the keys and certificates from the keystore without proper credentials.&lt;/p&gt;&lt;h1&gt;Impact&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Information Disclosure:&lt;/strong&gt; The attacker can gain access to the keys used by the application, allowing them to decrypt data the application attempts to protect with encryption, and to spoof the application to itself or other systems which trust data encrypted with those keys. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Elevation of Privilege:&lt;/strong&gt; The attacker may also be able to add new keys to the keystore or modify existing ones. This can result in the application trusting keys controlled by the attacker for sensitive operations or communicating with other systems.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Vulnerabilities&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Using a Weak Keystore:&lt;/strong&gt; Many operating environments provide a variety of key stores, some of which exist only for legacy reasons. Using an older version of a key store or a poorly implemented third party key store is likely to result in a key store compromise. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Improperly Configuring a Strong Keystore:&lt;/strong&gt; Many keystores support a variety of configuration options which allow for a wide range of security choices. Understanding the properties of your key store is essential to using it securely. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Implementing a Custom or Homegrown Keystore:&lt;/strong&gt; Strong keystores are both very tricky to write and require support from the operating environment. Attempting to write one should be considered on the same level as implementing a custom encryption algorithm or protocol, and should be avoided. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Poor Key Handling:&lt;/strong&gt; If the application isn't careful with how it manages keys when it adds them to the store or reads them out from the store for use, both key compromise and key disclosure are possible, even if the key store itself is strong.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Countermeasures&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Use a Strong Keystore:&lt;/strong&gt; Which key store to use will vary by your platform. In Java, use the &lt;strong&gt;KeyStore&lt;/strong&gt; class. On Windows, use DPAPI. Ensure that you are using the current version of the key store for your platform, including any patches.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Configure Your Keystore Correctly:&lt;/strong&gt; Ensure that you know how to properly configure the key store in your environment. Ensure that any ACLs on the key store are locked down as tightly as possible while still allowing your system to function. For instance, after the initial install, it is unlikely that your application will need rights to add keys to the key store, nor rights to change the permissions on the key store; if possible, make sure the application gives these up after installation. Ensure that, if possible, all cryptographic operations occurr within the scope of the protected keystore, instead of manual exporting keys from the store or reading the bits out; if you can do this and you can lock your key store down even further, ensure that these operations cannot be performed on the key store. If you have a choice of keys or algorithms used to protect keys in the key store, ensure that they are appropriately strong.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Ensure Proper Key Handling:&lt;/strong&gt; Handle your key material very carefully. Place keys in the key store as soon as possible and read them out as late as possible. Do not leave keys in memory when you do not need them, and ensure that the memory that you load them into is properly zeroed out. Be careful with immutable objects and garbage collection when handling key data. Under no circumstances should cleartext keys be written out to disk; among other things, make sure that you pin memory with sensitive data so that it will not be written out to swap.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="http://java.sun.com/j2se/1.4.2/docs/api/java/security/KeyStore.html"&gt;http://java.sun.com/j2se/1.4.2/docs/api/java/security/KeyStore.html&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="http://msdn2.microsoft.com/en-us/library/ms995355.aspx"&gt;http://msdn2.microsoft.com/en-us/library/ms995355.aspx&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:235E588E-621B-4C5E-A50E-8EA447330AD0"&gt;Guideline: Use a Secure Key Storage Location &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:6D0F24EA-B130-4AAE-9EDF-0B27F04B3145"&gt;Attack: Credentials Brute Force Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:24D078E3-A02F-4EDF-A6EA-DA0E3E5FFE5E"&gt;Attack: Key Bruteforce Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:4507A940-9C44-4FD9-A946-97B2CD53D08E"&gt;Attack: Local Machine Credential Sniffing Attack&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>