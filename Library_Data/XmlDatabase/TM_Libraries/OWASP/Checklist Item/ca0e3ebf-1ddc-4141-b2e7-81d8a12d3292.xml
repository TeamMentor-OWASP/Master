<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="ca0e3ebf-1ddc-4141-b2e7-81d8a12d3292" Author="" Category="Input and Data Validation" Priority="2" Rule_Type="Checklist Item" Status="" Technology="ASP.NET 3.5" title="Application Avoids File Name And Path Input" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Check For&lt;/h1&gt;&lt;p&gt;Unless absolutely necessary, the application should not accept file names or file paths as input.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Malicious file input can be used to coerce your application into accessing arbitrary files and resources.&lt;/p&gt;&lt;h1&gt;How to Check&lt;/h1&gt;&lt;p&gt;Use the following steps to check for this problem:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Find all sources of input in your application. &lt;/strong&gt;During design time identify all of the potential sources of input to your application. Scour the source code to discover sources of input that may have been missed in the design. Compile a list that you can use in the following steps.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Determine if any source of input provides file or path information. &lt;/strong&gt;Examine each source of input and determine if it is used to generate a file name or file path.&amp;nbsp;Look not only for sources of input that provide full paths or file names but also for user input that could be used to modify the internal generation of paths and file names.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;How to Fix&lt;/h1&gt;&lt;p&gt;If user control over file paths or file names is not absolutely necessary, remove the responsible code from the application.&lt;/p&gt;
&lt;p&gt;If the functionality is critical to the proper working of the application, then validate the input for directory traversal and canonicalization attacks:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Check File Names. &lt;/strong&gt;Ensure that file paths only refer to files within your application's virtual directory hierarchy if that is appropriate. When checking file names, obtain the full name of the file by using the &lt;strong&gt;System.IO.Path.GetFullPath&lt;/strong&gt; method. &lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Check File Paths. &lt;/strong&gt;If you use &lt;strong&gt;MapPath&lt;/strong&gt; to map a supplied virtual path to a physical path on the server, use the overloaded &lt;strong&gt;Request.MapPath&lt;/strong&gt; method that accepts a &lt;strong&gt;bool&lt;/strong&gt; parameter so that you can prevent cross-application mapping: &lt;/p&gt;&lt;pre&gt;try&lt;br&gt;{&lt;br&gt;  string mappedPath = Request.MapPath( inputPath.Text,&lt;br&gt;                                       Request.ApplicationPath, false);&lt;br&gt;}&lt;br&gt;catch (HttpException)&lt;br&gt;{&lt;br&gt;  // Cross-application mapping attempted&lt;br&gt;}&lt;/pre&gt;&lt;p&gt;The final &lt;strong&gt;false&lt;/strong&gt; parameter prevents cross-application mapping. This means that a user cannot successfully supply a path that contains ".." to traverse outside of your application's virtual directory hierarchy. Any attempt to do this results in an exception of type &lt;strong&gt;HttpException&lt;/strong&gt;. &lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:4ce86b45-ffb7-4646-9f8f-01f87be439da"&gt;Checklist Item: If Input File Names Are Required, They Are Well Formed and Are Verifiably Valid Within the Application Context &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:581e8fff-7841-49ac-8bbe-d74e44aa9bd8"&gt;Checklist Item: All Input is Validated For Length, Range, Format, and Type&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:06365970-3114-4529-babc-291614a2f794"&gt;Guideline: Do not Accept File Names or Paths from Users&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;p&gt;Adapted from Microsoft patterns &amp;amp; practices guidance. &lt;/p&gt;</content>
</guidanceItem>