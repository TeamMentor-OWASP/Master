<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="d4ae5fa9-2156-42d1-8718-754a7df4e1f5" Author="" Category="Parameter Manipulation" Priority="2" Rule_Type="Checklist Item" Status="" Technology="ASP.NET 3.5" title="The ViewStateUserKey Is Used to Counter Cross-site Request Forgery Attacks" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Check For&lt;/h1&gt;&lt;p&gt;Ensure that an unique key is assigned to each user's ViewState.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;A ViewState is the mechanism used by ASP.NET to keep track of server control state values. It is a hidden form field managed by the ASP.NET page framework and is an encoded aggregate of values of controls on a page. View state is enabled by default in ASP.NET and can be disabled or re-enabled at the machine, application, page, and control level by setting the &lt;strong&gt;EnableViewState&lt;/strong&gt; property to &lt;strong&gt;false&lt;/strong&gt; or &lt;strong&gt;true&lt;/strong&gt; in config files.&lt;/p&gt;&lt;p&gt;By default, there's nothing in the ViewState that ties its content to a particular user. The attacker can easily reuse the ViewState he obtained making legal access to the page to build a bogus request on behalf of another user. This is where &lt;strong&gt;ViewStateUserKey&lt;/strong&gt; is useful.&lt;/p&gt;&lt;p&gt;The &lt;strong&gt;ViewStateUserKey&lt;/strong&gt; property adds user-specific information to the view state. Setting the &lt;strong&gt;ViewStateUserKey&lt;/strong&gt; property of the page in the &lt;strong&gt;Page_Init&lt;/strong&gt; event handler helps ensuring that any form information submitted came from the same user who requested the original page. It binds the content of the &lt;strong&gt;ViewState&lt;/strong&gt; variable to individual users so that the malicious users cannot use the variable to generate an attack.&lt;/p&gt;&lt;p&gt;This prevents &lt;a href="ruledisplay:2288423A-5696-41EA-A421-05EAD6460E4C"&gt;Cross Site Request Forgery&lt;/a&gt; attacks, where attackers attempt to use their ViewState in the context of another user or to otherwise post form data as though they were another user. These attacks are also called One-Click Attacks.&lt;/p&gt;&lt;h1&gt;How to Check&lt;/h1&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Verify that your application's ASP.NET pages have Page_Init methods. &lt;/strong&gt;Look for &lt;strong&gt;Page_Init&lt;/strong&gt; methods in your application's ASP.NET. The declaration for &lt;strong&gt;Page_Init&lt;/strong&gt; is:&lt;/p&gt;&lt;pre&gt;protected void Page_Init(object sender, EventArgs e)&lt;/pre&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Verify that Page.ViewStateUserKey is set during page initialization. &lt;/strong&gt;Ensure &lt;strong&gt;Page.ViewStateUserKey&lt;/strong&gt; is initialized during page initialization. Example:&lt;/p&gt;&lt;pre&gt;protected void Page_Init(object sender, EventArgs e&lt;br&gt;{&lt;br&gt;    Page.ViewStateUserKey = Session.SessionID;&lt;br&gt;}&lt;/pre&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;Suppose that a&amp;nbsp;web application does not set the &lt;strong&gt;ViewStateUserKey&lt;/strong&gt; property in the Page_Init event handler, and this application allows a user to change the state of the application in a single request. This combination means the&amp;nbsp;application is susceptible to a Cross Site Request Forgery Attack. &lt;/p&gt;&lt;p&gt;For example, consider a web application that allows a logged-in administrator to create a new user sending a single GET request.&lt;/p&gt;&lt;p&gt;This GET request looks like this:&lt;/p&gt;&lt;pre&gt;GET http://teammentorexample.com/adduser.aspx?username=joe&amp;amp;password=1234&amp;amp;usertype=user HTTP/1.1&lt;/pre&gt;&lt;p&gt;The attacker discovers that this request will create a new user and creates his own request which he embeds in an e-mail with the following image tag:&lt;/p&gt;&lt;pre&gt;&amp;lt;img src=”http://teammentorexample.com/adduser.aspx?username=HACKER&amp;amp;password=TEST&amp;amp;usertype=admin” /&amp;gt;&lt;/pre&gt;&lt;p&gt;When the victim’s (the administrator in this case) e-mail client attempts to download the image located at the above source, the request is made without the knowledge of the victim. &lt;/p&gt;&lt;p&gt;The Web page contains a hidden form field named __VIEWSTATE that is already filled with ViewState data. The ViewState can be re-used from a valid request that the attacker had previously made to the application. The ViewState content is not checked on the server or is only checked against tampering. The attacker lures the unsuspecting user into opening the email containing the malicious URL, causing the request to be sent to the server where the ViewState is valid. The server has no way of knowing that the ViewState originated from the attacker. ViewState validation does not counter this attack because the ViewState is valid and the page is executed under the security context of the victim user.&lt;/p&gt;&lt;h1&gt;Related Guideline&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:04A281E9-1078-48B4-ABBC-74CB259F8C92"&gt;Guideline: Use Page.ViewStateUserKey to Counter Cross Site Request Forgery Attacks&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;p&gt;Adapted from Microsoft patterns &amp;amp; practices guidance. &lt;/p&gt;</content>
</guidanceItem>