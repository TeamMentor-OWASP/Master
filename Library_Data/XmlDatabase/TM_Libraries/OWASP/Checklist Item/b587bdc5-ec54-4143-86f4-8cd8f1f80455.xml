<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="b587bdc5-ec54-4143-86f4-8cd8f1f80455" Author="" Category="Input and Data Validation" Priority="1" Rule_Type="Checklist Item" Status="" Technology="Java" title="Input from All Sources Is Validated" Topic="Security" phase="Design" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Check For&lt;/h1&gt;&lt;p&gt;Check for input that has not been passed through a validation routine. All input from external sources should be validated.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Input that is not validated can lead to cross-site scripting, SQL injection, directory traversals, and other vulnerabilities which would allow an attacker to gain unauthorized access to sensitive data.&lt;/p&gt;&lt;h1&gt;How to Check&lt;/h1&gt;&lt;p&gt;An application can take input via various ways such as a web interface, database, file system or other software running on the server. Use the following steps to establish a validation strategy:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify all sources of input.&lt;br&gt;&lt;/strong&gt;At design time identify all potential sources of input to your application. Once implemented, scour source code to discover sources of input that may have been missed in the design. Potential sources of input in a web application typically include:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;URL based parameters &lt;/li&gt;&lt;li&gt;Form based parameters &lt;/li&gt;&lt;li&gt;Hidden fields &lt;/li&gt;&lt;li&gt;Cookies &lt;/li&gt;&lt;li&gt;HTTP headers (Host, accept types, www authentication, cache settings, encodings, etc) &lt;/li&gt;&lt;li&gt;Local filesystem &lt;/li&gt;&lt;li&gt;Database &lt;/li&gt;&lt;li&gt;Other services running on the system &lt;/li&gt;&lt;li&gt;Javascript variables &lt;/li&gt;&lt;li&gt;File upload and attributes (filename, size, data, etc) &lt;/li&gt;&lt;li&gt;DNS results or host names &lt;/li&gt;&lt;li&gt;External component call return values (COM, AJAX, ActiveX) &lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Once you know&amp;nbsp;the types of input from where your application may receive data, look for all entry points. Good starting points are method parameters and assignment statements. For example: &lt;/p&gt;&lt;p&gt;This method uses the &lt;strong&gt;searchTerm&lt;/strong&gt; variable:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;void aggregateData(PrintWriter out, String searchTerm)&lt;br&gt; ...&lt;br&gt;double[] rData = common.queryDBForIndex(searchTerm);&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;This assignment stores data from a &lt;strong&gt;GET&lt;/strong&gt; request parameter named &lt;strong&gt;index&lt;/strong&gt; and stores it in the &lt;strong&gt;String searchTerm&lt;/strong&gt;. Ensure that this input is validated:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;String searchTerm = request.getParameter("index");&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;This assignment uses the input that was gathered above to store more input from a database. Verify that &lt;strong&gt;searchTerm&lt;/strong&gt; is validated before this use, and also ensure that &lt;strong&gt;rData&lt;/strong&gt; is validated as another source of input.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;double[] rData = common.queryDBForIndex(searchTerm);&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Trace data from source to sink.&lt;br&gt;&lt;/strong&gt;Trace each source of input from the immediate source through your application to its final destination. The final sink may be in memory, on the hard drive, sent over the network or stored in a data store such as a database.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify validation routines.&lt;br&gt;&lt;/strong&gt;Each input source should have a validation routine associated with it. Ideally the validation will occur as soon as the input reaches your application. Shared validation routines are better than creating many throughout the code base, so check for consolidation of routines to aid testing and reduce the chance of one-off bugs. If any input source does not have a validation routine associated with it, flag it for fixing.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Ensure quality of validators.&lt;br&gt;&lt;/strong&gt;Validation routines should check for length, range, format and type. Validation should first check for good data through whitelisting then for known malicious data through blacklisting. Do not rely on client-side validation alone as it can be bypassed easily.&lt;br&gt;&lt;br&gt;For more information see Checklist Item: &lt;a href="ruledisplay:6D944640-22E7-421F-8192-45730D5118AB"&gt;Input is Validated for Length, Range, Format and Type&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following code produces a data analysis based on a financial index. Unfortunately, the application validates the user's input but not the returned data from the database. Therefore, the application is vulnerable to an integer overflow that can harm the business logic used in generating the data analysis.&lt;/p&gt;&lt;br&gt;&lt;blockquote&gt;&lt;pre&gt;import java.io.*;&lt;br&gt;import java.util.*;&lt;br&gt;import java.lang.*;&lt;br&gt;import javax.servlet.*;&lt;br&gt;import javax.servlet.http.*;&lt;br&gt;import java.util.regex.*;&lt;br&gt; public final class DataAggregator extends HttpServlet&lt;br&gt;{&lt;br&gt;      public void doGet(HttpServletRequest request, HttpServletResponse response)&lt;br&gt;            throws ServletException, IOException&lt;br&gt;      {&lt;br&gt;            PrintWriter out = response.getWriter();&lt;br&gt;            String searchTerm = request.getParameter("index");&lt;br&gt;             try&lt;br&gt;            {&lt;br&gt;                  // The application validates the user-supplied input&lt;br&gt;                  if (validateSearchTerm(searchTerm))&lt;br&gt;                  {&lt;br&gt;                        String retString;&lt;br&gt;                        retString = "The queried index \"";&lt;br&gt;                        retString += encodeHtml(searchTerm);&lt;br&gt;                        retString += "\" produced the following results:&amp;lt;br&amp;gt; ";&lt;br&gt;                        out.println(retString);&lt;br&gt;                        aggregateData(out, searchTerm);&lt;br&gt;                  }&lt;br&gt;                  else&lt;br&gt;                  {&lt;br&gt;                        // Add the appropriate logging and exception handling&lt;br&gt;                        // mechanisms. Consult the Exception Handling and&lt;br&gt;                        // Logging sections&lt;br&gt;                        out.println("We cannot handle your request at the moment."&lt;br&gt;                                 + " Please try again later.");&lt;br&gt;                  }&lt;br&gt;            }&lt;br&gt;             catch (Exception e)&lt;br&gt;            {&lt;br&gt;                   // Add the appropriate logging and exception handling&lt;br&gt;                   // mechanisms. Consult the Exception Handling and&lt;br&gt;                   // Logging sections&lt;br&gt;                   out.println("We cannot handle your request at the moment."&lt;br&gt;                           + " Please try again later.");&lt;br&gt;            }&lt;br&gt;             out.flush();&lt;br&gt;             out.close();&lt;br&gt;      }&lt;br&gt;       boolean validateSearchTerm(String input)&lt;br&gt;      {&lt;br&gt;            String goodPattern = "(\\w|\\d)+";&lt;br&gt;            int goodLength = 8;&lt;br&gt;             if (input == null)&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;             if(input.length() &amp;gt; goodLength)&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;                        Pattern p = Pattern.compile(goodPattern);&lt;br&gt;            Matcher m = p.matcher(input);&lt;br&gt;                        if(!m.matches())&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;                        return true;&lt;br&gt;      }&lt;br&gt;       void aggregateData(PrintWriter out, String searchTerm)&lt;br&gt;      {&lt;br&gt;            double[] rData = common.queryDBForIndex(searchTerm);&lt;br&gt;             // The application fails to validate the returned&lt;br&gt;             // data from the database&lt;br&gt;             // Business logic that performs certain data analysis&lt;br&gt;      }&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Related Guideline&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:71225A92-ECA2-481E-ADEE-EA9C222DEA43"&gt;Guideline: Validate Input from All Sources (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>