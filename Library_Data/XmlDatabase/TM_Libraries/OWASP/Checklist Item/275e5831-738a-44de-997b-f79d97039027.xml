<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="275e5831-738a-44de-997b-f79d97039027" Author="" Category="Input and Data Validation" Priority="1" Rule_Type="Checklist Item" Status="" Technology="Java" title="All Output Data Is Encoded" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Check For&lt;/h1&gt;&lt;p&gt;Ensure that all echoed input is first encoded.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Encoding echoed input prevents injection attacks such as cross-site scripting.&lt;/p&gt;&lt;h1&gt;How to Check&lt;/h1&gt;&lt;p&gt;An application can take input via various&amp;nbsp;sources, such as a web interface, database, file system or other software running on the server, and then use that same input in various outputs. Use the following steps to establish a validation strategy:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify all sources of input. &lt;/strong&gt;At design time identify all potential sources of input to your application. Once implemented, scour source code to discover sources of input that may have been missed in the design. Potential sources of input in a web application typically include:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;URL based parameters &lt;/li&gt;&lt;li&gt;Form based parameters &lt;/li&gt;&lt;li&gt;Hidden fields &lt;/li&gt;&lt;li&gt;Cookies &lt;/li&gt;&lt;li&gt;HTTP headers (Host, accept types, www authentication, cache settings, encodings, etc) &lt;/li&gt;&lt;li&gt;Local filesystem &lt;/li&gt;&lt;li&gt;Database &lt;/li&gt;&lt;li&gt;Other services running on the system &lt;/li&gt;&lt;li&gt;Javascript variables &lt;/li&gt;&lt;li&gt;File upload and attributes (filename, size, data, etc) &lt;/li&gt;&lt;li&gt;DNS results or host names &lt;/li&gt;&lt;li&gt;External component call return values (COM, AJAX, ActiveX) &lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Once you&amp;nbsp;have listed the sources of input your application&amp;nbsp;can use, look for all entry points. Good starting points are method parameters and assignment statements. For example: &lt;/p&gt;&lt;p&gt;This method uses the &lt;strong&gt;searchTerm&lt;/strong&gt; variable.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;void aggregateData(PrintWriter out, String searchTerm)&lt;br&gt; ...&lt;br&gt;&lt;br&gt;double[] rData = common.queryDBForIndex(searchTerm);&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;This assignment stores data from a &lt;strong&gt;GET&lt;/strong&gt; request parameter named &lt;strong&gt;index&lt;/strong&gt; and stores it in the &lt;strong&gt;String searchTerm&lt;/strong&gt;. Ensure that this input is validated.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;String searchTerm = request.getParameter("index");&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;This assignment uses the input that was gathered above to store more input from a database. Verify that &lt;strong&gt;searchTerm&lt;/strong&gt; is validated before this use, and also ensure that &lt;strong&gt;rData&lt;/strong&gt; is validated as another source of input.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;double[] rData = common.queryDBForIndex(searchTerm);&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Trace data from source to sink. &lt;/strong&gt;Trace each source of input from the immediate source, through your application, to its final destination. The final sink may be in memory, on the hard drive, sent over the network or stored in a data store such as a database. Create a list of the input sources that are echoed back to the user through output - whether directly, through a file, in a URL or through a database or other intermediary source.&lt;/p&gt;&lt;p&gt;Input used as output may be identified by the following:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;out.println() &lt;/li&gt;&lt;li&gt;append() &lt;/li&gt;&lt;li&gt;insert() &lt;/li&gt;&lt;li&gt;write() &lt;/li&gt;&lt;li&gt;Assignment operator (=) &lt;/li&gt;&lt;li&gt;Increment and assignment operator (+=) &lt;/li&gt;&lt;li&gt;Database write operations&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Ensure input is properly encoded before being used as output. &lt;/strong&gt;Each of the input sources identified above should have the input encoded properly before it is used as output. Encoding must be selected appropriately based upon how the output is returned to the client - either as HTML content or in a URL. Verify the context in which the output is used and ensure it is properly encoded:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;URLs - &lt;strong&gt;URLEncoder.encode(output)&lt;/strong&gt; &lt;/li&gt;&lt;li&gt;HTML - JSP HTML encoding: &lt;strong&gt;&amp;lt;%= {output} %&amp;gt;&lt;/strong&gt;&lt;/li&gt;&lt;/ul&gt;&lt;strong&gt;Note: &lt;/strong&gt;A custom HTML encoder can be developed as shown below but using built-in functionality whenever possible is recommended. &lt;ul&gt;&lt;/ul&gt;&lt;p&gt;Be aware that data taken from the URL and used within the HTML must be HTML encoded, not URL encoded. Consider a dynamically created form, which builds the &lt;strong&gt;ACTION&lt;/strong&gt; tag from the current URL used to access the form. The user-supplied URL is used as input in this case, and the output is directly to the HTML page created. The URL must be HTML encoded prior to being used to avoid script injection issues. See the example below:&lt;/p&gt;&lt;p&gt;User URL provided: &lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;http://server/form?x=&lt;strong&gt;"&amp;gt;&amp;lt;SCRIPT&amp;gt;alert('XSS');&amp;lt;/SCRIPT&amp;gt;&lt;/strong&gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;No encoding:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;&amp;lt;form action="http://server/form?x=&lt;strong&gt;"&amp;gt;&amp;lt;SCRIPT&amp;gt;alert('XSS');&amp;lt;/SCRIPT&amp;gt;&lt;/strong&gt;"&amp;gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;URL Encoding:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;&amp;lt;form action="http://server/form%3Fx%3D&lt;strong&gt;%22%3E%3CSCRIPT%3Ealert%28%27XSS%27%29%3B%3C/SCRIPT%3E&lt;/strong&gt;"&amp;gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;HTML Encoding:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt; &amp;lt;form action="http://server/form?x=&lt;strong&gt;&amp;amp;quot;&amp;lt;&amp;lt;SCRIPT&amp;lt;alert('XSS');&amp;lt;/SCRIPT&amp;lt;&lt;/strong&gt;"&amp;gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following code produces a data analysis based on a financial index. Because it does not HTML encode the echoed input, the application is vulnerable to reflective cross-site scripting.&lt;/p&gt;&lt;br&gt;&lt;blockquote&gt;&lt;pre&gt;import java.io.*;&lt;br&gt;import java.util.*;&lt;br&gt;import java.lang.*;&lt;br&gt;import javax.servlet.*;&lt;br&gt;import javax.servlet.http.*;&lt;br&gt;import java.util.regex.*;&lt;br&gt; public final class DataAggregator extends HttpServlet&lt;br&gt;{&lt;br&gt;      public void doGet(HttpServletRequest request, HttpServletResponse response)&lt;br&gt;            throws ServletException, IOException&lt;br&gt;      {&lt;br&gt;            PrintWriter out = response.getWriter();&lt;br&gt;            String searchTerm = request.getParameter("index");&lt;br&gt;             try&lt;br&gt;            {&lt;br&gt;                  if (validateSearchTerm(searchTerm))&lt;br&gt;                  {&lt;br&gt;                        String retString;&lt;br&gt;                        retString = "The queried index \"";&lt;br&gt;                        // The application does not HTML encode the returned input&lt;br&gt;                        retString += searchTerm;&lt;br&gt;                        retString += "\" produced the following results:&amp;lt;br&amp;gt; ";&lt;br&gt;                        out.println(retString);&lt;br&gt;                        common.aggregateData(out, searchTerm);&lt;br&gt;                  }&lt;br&gt;                  else&lt;br&gt;                  {&lt;br&gt;                        // Add the appropriate logging and exception handling&lt;br&gt;                        // mechanisms. Consult the Exception Handling and&lt;br&gt;                        // Logging sections&lt;br&gt;                        out.println("We cannot handle your request at the moment."&lt;br&gt;                                 +  "Please try again later.");&lt;br&gt;                  }&lt;br&gt;            }&lt;br&gt;             catch (Exception e)&lt;br&gt;            {&lt;br&gt;                  // Add the appropriate logging and exception handling&lt;br&gt;                  // mechanisms. Consult the Exception Handling&lt;br&gt;                  // and Logging sections&lt;br&gt;                  out.println("We cannot handle your request at the moment."&lt;br&gt;                           +  "Please try again later.");&lt;br&gt;            }&lt;br&gt;             out.flush();&lt;br&gt;&lt;br&gt;             out.close();&lt;br&gt;      }&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;To learn more about cross-site scripting, including a library to help defend against cross-site scripting attacks, see: &lt;a href="http://www-128.ibm.com/developerworks/tivoli/library/s-csscript/"&gt;Cross-site scripting&lt;/a&gt;. &lt;/li&gt;&lt;li&gt;To learn more about cross-site scripting, see: &lt;a href="http://today.java.net/pub/a/today/2005/09/20/handling-web-app-input.html"&gt;Handling Java Web Application Input, Part 2&lt;/a&gt;. &lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Guideline&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:2D8158D1-E2D1-459F-9BD7-56D4B979EFE3"&gt;Guideline: Encode All Output Data (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>