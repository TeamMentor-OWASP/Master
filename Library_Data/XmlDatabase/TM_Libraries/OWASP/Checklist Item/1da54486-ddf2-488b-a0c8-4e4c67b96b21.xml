<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="1da54486-ddf2-488b-a0c8-4e4c67b96b21" Author="" Category="Input and Data Validation" Priority="2" Rule_Type="Checklist Item" Status="" Technology="ASP.NET 3.5" title="If Input File Names Are Required, They Are Well Formed And Are Verifiably Valid Within the Application Context" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Check For&lt;/h1&gt;&lt;p&gt;Ensure that user-supplied filenames or paths are in the correct format and point to a valid location in the context of your application. &lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Malicious file input can be used to coerce your application into accessing arbitrary files and resources. &lt;/p&gt;&lt;h1&gt;How to Check&lt;/h1&gt;&lt;p&gt;If your application accepts user supplied files or paths, ensure that they are passed through a validation routine. The validation routine should not only check for appropriate format, but also ensure that the file name is legitimate for your application.&lt;/p&gt;&lt;p&gt;For more information on input validation, see the related checklist item All Input is Validated for Length, Range, Format, and Type, linked below. &lt;/p&gt;&lt;h1&gt;How to Fix&lt;/h1&gt;&lt;p&gt;Use the following steps to fix this issue:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Check File Names. &lt;/strong&gt;Ensure that file paths only refer to files within your application's virtual directory hierarchy if that is appropriate. When checking file names, obtain the full name of the file by using the &lt;strong&gt;System.IO.Path.GetFullPath&lt;/strong&gt; method. &lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Check File Paths. &lt;/strong&gt;If you use &lt;strong&gt;MapPath&lt;/strong&gt; to map a supplied virtual path to a physical path on the server, use the overloaded &lt;strong&gt;Request.MapPath&lt;/strong&gt; method that accepts a &lt;strong&gt;bool&lt;/strong&gt; parameter so that you can prevent cross-application mapping. The following code example shows this technique:&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;blockquote&gt;&lt;pre&gt;try&lt;br&gt;{&lt;br&gt; string mappedPath = Request.MapPath( inputPath.Text,&lt;br&gt;                                       Request.ApplicationPath, false);&lt;br&gt;}&lt;br&gt;catch (HttpException)&lt;br&gt;{&lt;br&gt; // Cross-application mapping attempted &lt;br&gt;}&lt;/pre&gt;&lt;p&gt;The final &lt;strong&gt;false&lt;/strong&gt; parameter prevents cross-application mapping. This means that a user cannot successfully supply a path that contains ".." to traverse outside of your application's virtual directory hierarchy. Any attempt to do this results in an exception of type &lt;strong&gt;HttpException&lt;/strong&gt;. &lt;/p&gt;&lt;/blockquote&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;div&gt;&lt;a href="ruledisplay:581e8fff-7841-49ac-8bbe-d74e44aa9bd8"&gt;Checklist Item: All Input is Validated for Length, Range, Format, and Type&lt;/a&gt;&lt;/div&gt;&lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;p&gt;Adapted from Microsoft patterns &amp;amp; practices guidance. &lt;/p&gt;</content>
</guidanceItem>