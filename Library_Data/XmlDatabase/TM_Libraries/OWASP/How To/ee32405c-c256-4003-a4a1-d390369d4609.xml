<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="ee32405c-c256-4003-a4a1-d390369d4609" Author="" Category="Cryptography" Priority="" Rule_Type="How To" Status="" Technology=" Any" title="How to Test for Chosen Plaintext Bugs" Topic="Security" phase="Test" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;Applies to&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Public and private key encryption algorithms&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Summary&lt;/h1&gt;&lt;p&gt;The adversary's ideal goal when attacking cryptographic systems is to recover the cryptographic key or to decipher specific encrypted information.&amp;nbsp;In the ideal case, a remote adversary can only sniff the encrypted packets; they can';t manipulate either the text before encryption (plaintext) or the text after encryption (ciphertext).&amp;nbsp;A chosen plaintext bug allows adversaries to choose any particular plaintext they want. The adversary tricks the victim in to encrypting their own plaintext (&lt;em&gt;P&lt;/em&gt;) and gathers useful information from the resulting ciphertext (&lt;em&gt;C&lt;/em&gt;).&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/p&gt;&lt;p&gt;The following steps are recommended to test for chosen plaintext bugs:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Step 1:&amp;nbsp; Understand Attack Scenarios &lt;/li&gt;&lt;li&gt;Step 2:&amp;nbsp; Analyze Root Causes and Mitigations &lt;/li&gt;&lt;li&gt;Step 3:&amp;nbsp; Start Testing and Exploring &lt;/li&gt;&lt;li&gt;Step 4:&amp;nbsp; Tune Test Cases&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Step 1:&amp;nbsp; Understand Attack Scenarios&lt;/h1&gt;&lt;p&gt;First, you need to understand the details of chosen plaintext attacks. The basic concept of a chosen plaintext attack is really simple: an attacker chooses &lt;em&gt;plaintext&lt;/em&gt; to feed the encryption algorithm they want to break.&amp;nbsp;There are two scenarios associated with this kind of bug:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Scenario 1:&amp;nbsp; Batched or offline chosen plaintext attack &lt;/li&gt;&lt;li&gt;Scenario 2:&amp;nbsp; Adaptive or online chosen plaintext attack&amp;nbsp;&amp;nbsp; &lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;Scenario 1:&amp;nbsp; Batched or offline chosen plaintext attack&lt;/h2&gt;&lt;p&gt;In the batched scenario, the attacker possesses all of the plaintext beforehand (prior to launching the attack and obtaining any ciphertext).&amp;nbsp;The attacker then encrypts the plaintext with the encryption system in question, finally obtaining the corresponding ciphertext.&amp;nbsp;This attack is commonly used in attempting to brute-force the private key of the encryption system.&amp;nbsp;&lt;/p&gt;&lt;h2&gt;Scenario 2:&amp;nbsp; Adaptive or online chosen plaintext attack&lt;/h2&gt;&lt;p&gt;In an online chosen plaintext attack, the attacker starts by reading one or more plaintext blocks and their corresponding ciphertext.&amp;nbsp;The attacker then generates new plaintext blocks based on information from previous sniffed packets.&amp;nbsp;The attacker then forces the victim to encrypt the new plaintext blocks; and finally, the attacker reads the ciphertext produced by their chosen plaintext blocks.&amp;nbsp;A common use of this attack is to steal sensitive information like passwords or credit card numbers.&amp;nbsp; &lt;/p&gt;&lt;p&gt;For instance, the attacker starts monitoring encrypted network traffic between a client and server. After some analysis, the attacker realizes that the client password is sent at a specific offset of a packet (&lt;em&gt;C&lt;/em&gt;). The attacker wants to know if the plaintext &lt;em&gt;P&lt;/em&gt; that produced the encrypted password (&lt;em&gt;C&lt;/em&gt;) is equivalent to another chosen plaintext &lt;em&gt;P';&lt;/em&gt;&lt;em&gt;.&lt;/em&gt; If the system suffers from a chosen plaintext vulnerability, the attacker creates different plaintexts &lt;em&gt;Pk';&lt;/em&gt; and forces the victim to use them in its following transmissions (which the attacker will also sniff).&amp;nbsp; For each plaintext&lt;em&gt;Pk';&lt;/em&gt; the attacker checks if the ciphertext &lt;em&gt;Ck';&lt;/em&gt; is &lt;em&gt;equivalent&lt;/em&gt; to &lt;em&gt;C.&amp;nbsp;&lt;/em&gt;If they are equivalent the chosen plaintext &lt;em&gt;Pk'; &lt;/em&gt;is equal to the client's password:&amp;nbsp;&amp;nbsp; &lt;/p&gt;&lt;p&gt;&lt;em&gt;C = E(K, P)&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/em&gt;&lt;/p&gt;&lt;p&gt;&lt;em&gt;Ck'; = E(K, Pk';)&lt;/em&gt;&lt;/p&gt;&lt;p&gt;If &lt;em&gt;Ck'; &lt;/em&gt;&lt;em&gt;Ëœ&lt;/em&gt;&lt;em&gt; C &lt;/em&gt;then &lt;em&gt;Pk';= P.&lt;/em&gt;&lt;/p&gt;&lt;p&gt;If the attack is successful, the attacker controls &lt;em&gt;Pk';&lt;/em&gt; and can read both &lt;em&gt;C&lt;/em&gt; and &lt;em&gt;Ck';. &lt;/em&gt;The only unknown values above are the encryption key (&lt;em&gt;K&lt;/em&gt;)and the client's password (&lt;em&gt;P&lt;/em&gt;).&lt;em&gt;&amp;nbsp;&amp;nbsp;&lt;/em&gt;&amp;nbsp;&lt;/p&gt;&lt;p&gt;Encryption systems require &lt;em&gt;block cipher modes&lt;/em&gt; to allow for encryption of more than one cipher block.&amp;nbsp;We say that a ciphertext in &lt;em&gt;Ck'; &lt;/em&gt;must be to &lt;em&gt;equivalent&lt;/em&gt; to&lt;em&gt;C &lt;/em&gt;because &lt;em&gt;Ck'; &lt;/em&gt;lives in a separate block (sent later) so it undergoes the cipher mode modification.&amp;nbsp; Nonetheless, if the attacker deduces this equivalence, they can verify if any of the predicted passwords in &lt;em&gt;Pk';&lt;/em&gt; are valid.&amp;nbsp;A system that uses insecure cipher modes (such as ECB) or is poorly implemented (i.e. using a predictable initialization vector or &lt;em&gt;IV&lt;/em&gt;) exposes itself to this variant [i] of attack.&amp;nbsp; &lt;/p&gt;&lt;h1&gt;Step 2:&amp;nbsp; Analyze Root Cause and Mitigations&lt;/h1&gt;&lt;p&gt;The next step is to analyze what causes chosen plaintext vulnerabilities and how to prevent them.&amp;nbsp; Knowing the root cause of security vulnerabilities helps you to identify them in both design and implementation (source code).&amp;nbsp;&amp;nbsp; &lt;/p&gt;&lt;h2&gt;Root Causes&lt;/h2&gt;&lt;p&gt;Any design, implementation, configuration, or deployment condition that leads to an &lt;em&gt;attacker controlling the plaintext&lt;/em&gt; &lt;em&gt;that the victim encrypts &lt;/em&gt;is a root cause of a chosen plaintext bug.&lt;/p&gt;&lt;p&gt;However, it is difficult to pinpoint the actual root causes for this vulnerability.&amp;nbsp; Picture a cryptography scenario wherein Alice sends Bob an encrypted message.&amp;nbsp; Alice encrypts a message on her computer before sending it to Bob.&amp;nbsp; An eavesdropper monitoring the encrypted communication is unable to change any of the plaintext; as the plaintext exists only on Alice's computer prior to encryption and transmission.&amp;nbsp; &lt;/p&gt;&lt;p&gt;To execute a chosen plaintext attack, the adversary needs to somehow infiltrate the victim's machine, or remotely force the victim to select the plaintext of their choice.&amp;nbsp; Any situation that allows a victim to encrypt the adversary's plaintext is a root cause of this vulnerability.&amp;nbsp; The challenge here is that these circumstances might fall outside of the encryption system's responsibility.&amp;nbsp; For example, the adversary might install a Trojan horse on Alice's computer which is then later used to replace any of Alice's plaintext before it is encrypted.&amp;nbsp; If the plaintext is replaced with that of the adversary's choice, the resulting ciphertext is that of the chosen plaintext after encryption.&amp;nbsp; The root cause here is that the victim previously allowed the attacker to install a trojan horse program, rather than a flaw in the encryption system itself.&lt;/p&gt;&lt;h2&gt;Mitigations&lt;/h2&gt;&lt;p&gt;Although there are multiple mitigations against this attack; none offer a complete solution.&amp;nbsp; In order to exploit this vulnerability, the adversary must choose from different attack avenues such as installing spyware, remotely corrupting the victim's file system, or otherwise forcing the victim to append the attacker's plaintext as part of an encrypted message.&amp;nbsp; Thus, possible mitigations include running up to date malware protection, hardening the operating system, and not including anonymous text in encrypted messages.&amp;nbsp; This emphasizes that there are many mitigations to aid in preventing this attack, and a defense in depth approach must be taken to minimize the overall risk.&lt;/p&gt;&lt;h1&gt;Step 3:&amp;nbsp; Start Testing and Exploring&lt;/h1&gt;&lt;p&gt;Now that you';ve learned about chosen plaintext attack scenarios, what causes them, and how to prevent them, you must test for secure and insecure implementations.&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;&lt;h2&gt;Testing against an offline chosen plaintext attack&lt;/h2&gt;&lt;ol&gt;&lt;li&gt;Select a victim. &lt;/li&gt;&lt;li&gt;Produce block(s) of plaintext that you wish to see enciphered. &lt;/li&gt;&lt;li&gt;Force the victim to encrypt the block(s) of plaintext produced in step 2. &lt;/li&gt;&lt;li&gt;Collect the resulting ciphertext for your chosen plaintext.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;Expected Result:&amp;nbsp; The test succeeds if you can';t get the victim to encipher the produced plaintext block(s) (step 3).&amp;nbsp; It fails if you are able to execute steps 3 and 4.&amp;nbsp;&lt;/p&gt;&lt;h2&gt;Testing against an online chosen plaintext attack&lt;/h2&gt;&lt;ol&gt;&lt;li&gt;Select a victim client. &lt;/li&gt;&lt;li&gt;Select a victim server. &lt;/li&gt;&lt;li&gt;Start sniffing network traffic between the client and server. &lt;/li&gt;&lt;li&gt;Read a number of messages between the server and the client. &lt;/li&gt;&lt;li&gt;Using information in the messages read, produce the plaintext you wish to force the server or the client to encrypt and send. &lt;/li&gt;&lt;li&gt;Force the victim server/client to encrypt the chosen plaintext from step 5. &lt;/li&gt;&lt;li&gt;Keep sniffing the network traffic until you see the resulting cipher text for the chosen plaintext in step 5.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;Expected Result:&amp;nbsp; The test succeeds if you can';t get the server to encipher the chosen plaintext (step 6).&amp;nbsp; It fails if you are able to execute steps 6 and 7.&lt;/p&gt;&lt;p&gt;These two high level cases show the basic details on how to test against a chosen plaintext attack.&amp;nbsp; Make sure to cover both cases when testing your encryption system.&amp;nbsp; During this step, you must be exploring ways of validating your test cases.&amp;nbsp; You must find a way to verify that your chosen plaintext is actually being encrypted and to match your chosen plaintext with its encrypted equivalent.&amp;nbsp; This will most likely require you to learn the protocol used between your target clients and servers, as well as exploration by trial and error.&lt;/p&gt;&lt;h1&gt;Step 4:&amp;nbsp; Tune Test Cases&lt;/h1&gt;&lt;p&gt;Now that you';ve gone over the basic tests against chosen plaintext bugs, you must revise additional testing details and implications depending on the system under attack.&lt;/p&gt;&lt;h3&gt;Attack Avenues&lt;/h3&gt;&lt;p&gt;Chosen plaintext attacks have a fundamental requirement: &lt;em&gt;the adversary needs to trick the victim into encrypting his chosen plaintext.&amp;nbsp; &lt;/em&gt;&lt;/p&gt;&lt;p&gt;A good example of applied chosen-plaintext testing attack avenues were presented along with an SSL chosen-plaintext vulnerability. &amp;nbsp;You';ve also seen some examples above.&amp;nbsp; This list presents a good set of attack avenues that you need to try:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Installing spyware or Trojan horse in the victim's system that modifies the chosen plaintext before it is encrypted by the victim. &lt;/li&gt;&lt;li&gt;Sending the chosen plaintext to the target in an attempt that the victim encrypts it in a reply. &lt;/li&gt;&lt;li&gt;Storing the chosen plaintext in a data store that will be later encrypted by the victim. &lt;/li&gt;&lt;li&gt;Sending the chosen plaintext as part of a plug-in installation. &lt;/li&gt;&lt;li&gt;Hijacking an encryption API and executing the encryption function from the tester's console, with the chosen plaintext, but in the victim's context (impersonating the victim). &lt;/li&gt;&lt;li&gt;Executing arbitrary code in the victim's context that calls the encryption procedure from that victim's context.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;As you can see, there are many routes to test for chosen plaintext bugs; and additional exploits appear frequently in the Internet.&amp;nbsp; It is important that you cover these routes and keep up with the latest attack avenues and techniques when testing against this class of bug.&lt;/p&gt;&lt;br&gt;&lt;h3&gt;Attack Methods&lt;/h3&gt;&lt;p&gt;As seen, it is possible to execute two different attack methods by exploiting chosen plaintext bugs:&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;em&gt;Breaking Encryption&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;The first method seen is that of recovering the encryption key of the encryption algorithm in use.&amp;nbsp; In general cryptography, the encryption and decryption routines are publically known since they should not be broken in a feasible time period with a strong key length.&amp;nbsp; However, sometimes cryptosystems utilize insufficiently large key sizes such as a 56-bit key paired with outdated algorithms like DES.&amp;nbsp; There are different ways to break an encryption algorithm and recover the key using appropriate cryptanalysis [ii]&amp;nbsp;methods, and this process can be much easier if the attacker has control of the plaintext.&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;em&gt;Stealing Sensitive Data &lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;In the second scenario you saw how to execute an information disclosure attack on the victim's password using a chosen plaintext bug.&amp;nbsp; When executing this payload the attacker is not trying to calculate the encryption key.&amp;nbsp; The attacker's goal is to reveal an unknown plaintext (The user's password.)&amp;nbsp; The attacker has access to the ciphertext produced by the unknown plaintext.&amp;nbsp; Furthermore, if a chosen plaintext bug exists, the attacker controls future plaintexts and therefore their resulting ciphertext.&amp;nbsp; The attacker produces plaintexts to send in to the encryption systems, in hopes that one of them will be equal to the original plaintext; the attacker then compares the produced ciphertexts with the original ciphertext to see if the plaintext has been discovered.&amp;nbsp;&amp;nbsp;&lt;/p&gt;&lt;p&gt;Ensure that you focus on testing one attack method at a time, rather than trying to test both simultaneously.&lt;/p&gt;&lt;h1&gt;&amp;nbsp;&lt;/h1&gt;&lt;h1&gt;Conclusions&lt;/h1&gt;&lt;p&gt;Chosen plaintext attacks are common in cryptography systems and have various potential implications.&amp;nbsp; The attacker uses this class of attack to compute the system's private encryption key, or in an attempt to discover secret plaintext such as a password or credit card number.&amp;nbsp; You must understand the basic attack scenarios for this class of attack, what causes them, and how to prevent them.&amp;nbsp; Then, test your application through its different attack avenues to reveal any vulnerabilities in your system.&amp;nbsp; Finish by tuning your test cases with the different attack methods presented here.&lt;/p&gt;&lt;div&gt;&lt;hr&gt;&lt;/div&gt;&lt;p&gt;[i] &lt;strong&gt;Vulnerability of SSL to Chosen-Plaintext Attack&lt;/strong&gt;.&lt;strong&gt;&amp;nbsp; &lt;/strong&gt;Gregory V. Bard.&amp;nbsp; May, 2004.&amp;nbsp; &lt;a href="http://citeseer.ist.psu.edu/cache/papers/cs/30519/http:zSzzSzeprint.iacr.orgzSz2004zSz111.pdf/bard04vulnerability.pdf"&gt;http://citeseer.ist.psu.edu/cache/papers/cs/30519/http:zSzzSzeprint.iacr.orgzSz2004zSz111.pdf/bard04vulnerability.pdf&lt;/a&gt;&lt;/p&gt;&lt;p&gt;[ii] &lt;strong&gt;Cryptanalysis&lt;/strong&gt;. Wikipedia. &amp;nbsp;&lt;a href="http://en.wikipedia.org/wiki/Cryptanalysis"&gt;http://en.wikipedia.org/wiki/Cryptanalysis&lt;/a&gt;&lt;/p&gt;&lt;div&gt;&lt;/div&gt;&lt;ul&gt;&lt;/ul&gt;</content>
</guidanceItem>