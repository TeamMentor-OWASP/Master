<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="9c905082-0a13-4641-b8cb-28e0bdc710c2" Author="" Category="Data Access" Priority="2" Rule_Type="Guideline" Status="" Technology="ASP.NET 3.5" title="Use RSA-Protected Configuration Provider in Web Farm Environments" Topic="Security" phase="Deployment" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Do&lt;/h1&gt;&lt;p&gt;Use the RSA Protected Configuration provider to encrypt sections of your configuration files. You can use Aspnet_regiis.exe tool to encrypt sensitive data, such as connection strings, held in the Web.config and Machine.config files.&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Connection strings contain sensitive resource access credentials (e.g., a connection string for a SQL server resource includes a username and password.) Connection strings stored in plaintext are dangerous, because an attacker that can compromise a server will be able to read those connection strings. Even if a machine is not compromised, connection strings stored in plain text&amp;nbsp;are accessible to administrators and any other users with sufficient privileges&amp;nbsp;on the host machine and/or Windows domain.&amp;nbsp;&lt;/p&gt;&lt;h1&gt;When&lt;/h1&gt;&lt;p&gt;Always encrypt connection strings. In&amp;nbsp;a web farm environment,&amp;nbsp;the RSA protected configuration provider is an effective way to encrypt and decrypt configuration file sections&amp;nbsp;because it uses asymmetric encryption to encrypt and decrypt,&amp;nbsp;meaning&amp;nbsp;the keys can easily be exported and imported&amp;nbsp;from server to server.&amp;nbsp; If the application is no deployed to a web farm environment DPAPI will work as well as RSA for encrypting connection strings.&amp;nbsp; &lt;/p&gt;&lt;h1&gt;How&lt;/h1&gt;&lt;p&gt;Use the following steps to encrypt sections of your configuration files: &lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify the configuration sections to be encrypted.&lt;/strong&gt; Encrypting and decrypting data incurs performance overhead. To keep this overhead to a minimum, encrypt only the sections of your configuration file that store sensitive data. In this case, we are interested in encrypting the &amp;lt;connectionStrings&amp;gt; element of the Web.config file since that is where the database connection string will reside. &lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Choose the machine or user store.&lt;/strong&gt; The DataProtectionConfigurationProvider supports machine-level and user-level stores for key storage. The choice of store depends largely on whether or not your application shares a server with other applications and whether or not sensitive data must be kept private for each application. &lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Encrypt your configuration file data.&lt;/strong&gt; Use the RSA Provider to Encrypt a Connection String in Web.config in a Web Farm. To do this, you must create a custom RSA encryption key container and deploy the same key container on all servers in your Web farm. This won't work by default because the default RSA encryption key, "NetFrameworkConfigurationKey", is different for each computer.&lt;/p&gt;&lt;p&gt;&amp;nbsp;Run&amp;nbsp;the following command from a .NET command prompt to encrypt the connectionStrings section using the machine level store:&lt;/p&gt;&lt;pre&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; aspnet_regiis -pe "connectionStrings" -app "/MachineRSA"&lt;/pre&gt;&lt;p&gt;Note: If your ASP.NET application identity does not have access to the .NET Framework configuration key store, you'll need to grant access.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;A web application is running in&amp;nbsp;a web farm environment. The application uses an SQL database instance and has sensitive data that should not be accessible to&amp;nbsp;other applications on the same system.&amp;nbsp;The web.config file contains a connectionString section that&amp;nbsp;the application uses to access the SQL database across all machines in the farm:&lt;/p&gt;&lt;pre&gt;&amp;lt;connectionStrings&amp;gt;  &lt;br&gt;&amp;lt;add name="MyLocalSQLServer"        &lt;br&gt;  connectionString="Initial Catalog=pubs;User Id=sa;Password=asdasd;       &lt;br&gt;  data source=localhost;Integrated Security=SSPI;"      &lt;br&gt;  providerName="System.Data.SqlClient"/&amp;gt;&lt;br&gt;&amp;lt;/connectionStrings&amp;gt;&lt;/pre&gt;&lt;p&gt;Unfortunately,&amp;nbsp;anyone capable of reading the web.config file for the application is now able to see the database, the username, and the password for the database instance, and will be able to execute statements at the same level of privilege as the application.&lt;/p&gt;&lt;h1&gt;Solution Example&lt;/h1&gt;&lt;p&gt;The web.config file for an application running in a web farm environment contains a connectionString section that&amp;nbsp;the application uses to access the SQL database across all machines in the farm:&lt;/p&gt;&lt;pre&gt;&amp;lt;connectionStrings&amp;gt;  &lt;br&gt;&amp;lt;add name="MyLocalSQLServer"        &lt;br&gt;  connectionString="Initial Catalog=pubs;User Id=sa;Password=asdasd;       &lt;br&gt;  data source=localhost;Integrated Security=SSPI;"       &lt;br&gt;  providerName="System.Data.SqlClient"/&amp;gt;&lt;br&gt;&amp;lt;/connectionStrings&amp;gt;&lt;/pre&gt;&lt;p&gt;Use the RSA Protected Configuration Provider&amp;nbsp;with the&amp;nbsp;machine key&amp;nbsp;store to encypt&amp;nbsp;the connectionStrings section. Add and configure a protected configuration provider to use the&amp;nbsp;machine key&amp;nbsp;store and run the following command from to encrypt the connectionStrings:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;aspnet_regiis -pe "connectionStrings" -app "/MachineRSA"&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;At this point the connection string has been encrypted, which can be verified by looking at the web.config file. There is no need to decrypt the file by hand, since ASP.NET handles this transparently.&amp;nbsp;&amp;lt;&amp;lt;Prashant - The solution does not talk about how the keys are exported and imported and used on other machines in the farm&amp;gt;&amp;gt;&lt;/p&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:f10679b7-5390-49ee-b529-7a2f7c059ce7"&gt;Encrypt Connection Strings&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:1fe40372-6648-4496-8552-794f91ff6bbf"&gt;Connection Strings are Secured&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;p&gt;Adapted from Microsoft patterns &amp;amp; practices guidance. &lt;/p&gt;</content>
</guidanceItem>