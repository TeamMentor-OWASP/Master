<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="a32c4cac-014c-4391-a5c1-6f30b318ad32" Author="" Category="Session Management" Priority="2" Rule_Type="Guideline" Status="" Technology="Java" title="Store JSESSIONIDs in the URL When Cookies Are Disabled" Topic="Security" phase="Design" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;Applies to&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Applications written using Servlets or JSP.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;What to Do&lt;/h1&gt;&lt;p&gt;Store the &lt;strong&gt;JSESSIONIDs&lt;/strong&gt; inside the URL when cookies are disabled by the browser.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;JSESSIONIDs&lt;/strong&gt; are the identifiers that match a client to a session. The use of truly random &lt;strong&gt;JSESSIONID&lt;/strong&gt; makes it difficult for an attacker to hijack the session and impersonate a user.&lt;/p&gt;&lt;h1&gt;When&lt;/h1&gt;&lt;p&gt;If your application supports authentication but cannot use cookies.&lt;/p&gt;&lt;h1&gt;How&lt;/h1&gt;&lt;p&gt;The only information that the browser needs to know once a session has been created for a user is its ID (i.e. &lt;strong&gt;JSESSIONID&lt;/strong&gt;). &lt;strong&gt;JSESSIONIDs&lt;/strong&gt; should be stored inside cookies. However, &lt;strong&gt;JSESSIONIDs&lt;/strong&gt; can be stored inside the URL if cookies are disabled. To use &lt;strong&gt;JSESSIONIDs&lt;/strong&gt; properly:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Check if cookies are accepted. &lt;/strong&gt;Verify whether the client has enabled cookies. Store &lt;strong&gt;JSESSIONIDs&lt;/strong&gt; in cookies if possible; however, if cookies are not enabled, Java allows session IDs to be passed in the URL.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Pass the session ID to the client. &lt;/strong&gt;Use one of the following approaches when passing the &lt;strong&gt;JSESSIONID&lt;/strong&gt; to the client:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Cookies&lt;/strong&gt;: Cookies are the preferred way of passing &lt;strong&gt;JSESSIONID&lt;/strong&gt; to the browser. The cookie should store only the session identifier and nothing more. All other data should reside inside the server-side session.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;HttpSession session = request.getSession(true);Subject subject = auth.getSubject();session.setAttribute("AuthUser", subject);&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;URL&lt;/strong&gt;: &lt;strong&gt;JSESSIONIDs&lt;/strong&gt; can also be stored in URLs. This should be a back-up approach that is executed only when cookies are disabled. Adding the session identifier into a URL is done through &lt;strong&gt;HttpServletResponse.encodeUrl&lt;/strong&gt;.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;String url = request.getRequestURL().toString();url = response.encodeURL(url);response.sendRedirect(url);&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;However, be exceptionally careful when linking to external sites. Because of the HTTP Referer header, the &lt;strong&gt;JSESSIONID&lt;/strong&gt; can leak out when following a link to an external site. This issue can be mitigated by setting up a forward page where &lt;strong&gt;JSESSIONIDs&lt;/strong&gt; are stripped from the URL and the user is forwarded to the external site.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following code shows the login interaction between the application and the user. Once the user requests the initial page, the application forwards him to the login screen. Upon verifying the credentials, the application loads the main application interface. Unfortunately, the application does not check whether the client supports cookies which causes&amp;nbsp;a broken access control, and&amp;nbsp;the valid user may not be able to access the application.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;&amp;lt;%-- Filename: /myapp/index.jsp --%&amp;gt;&lt;br&gt;&amp;lt;%-- The application fails to check whether the client supports cookies --%&amp;gt;&lt;br&gt;&amp;lt;jsp:forward page="/myapp/login.jsp" /&amp;gt;&lt;br&gt;  &lt;br&gt;&amp;lt;%-- Filename: /myapp/login.jsp --%&amp;gt;&lt;br&gt;&amp;lt;html&amp;gt;&lt;br&gt;  &amp;lt;head&amp;gt;&lt;br&gt;    &amp;lt;title&amp;gt;::login&amp;lt;/title&amp;gt;&lt;br&gt;  &amp;lt;/head&amp;gt;&lt;br&gt;  &amp;lt;body&amp;gt;&lt;br&gt;    &amp;lt;form method="POST" action="https://login.example.com/myapp/auth"&amp;gt;&lt;br&gt;    &amp;lt;input type="text" name="user" size="20"&amp;gt;&lt;br&gt;    &amp;lt;br&amp;gt;&amp;lt;input type="password" name="pass" size="20"&amp;gt;&lt;br&gt;    &amp;lt;br&amp;gt;&amp;lt;input type="submit" value="log in"&amp;gt;&amp;lt;/form&amp;gt;&lt;br&gt;  &amp;lt;/body&amp;gt;&lt;br&gt;&amp;lt;/html&amp;gt;&lt;br&gt;  /*  Filename: /myapp/auth  */&lt;br&gt;import java.io.*;&lt;br&gt;import java.util.*;&lt;br&gt;import javax.servlet.*;&lt;br&gt;import javax.servlet.http.*;&lt;br&gt; &lt;br&gt;public final class Auth extends HttpServlet{&lt;br&gt;      public void doGet(HttpServletRequest request,&lt;br&gt;              HttpServletResponse response) throws ServletException, IOException&lt;br&gt;      {&lt;br&gt;            HttpSession session = request.getSession(true);&lt;br&gt;            String redirectURL = "/myapp/main";&lt;br&gt; &lt;br&gt;            //The application fails to check whether the client supports cookies&lt;br&gt;            ...&lt;br&gt; &lt;br&gt;            response.sendRedirect(redirectURL);&lt;br&gt;      }&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Solution Example&lt;/h1&gt;&lt;p&gt;The following code shows the login interaction between the application and the user. Once the user requests the initial page, the application forwards him to the login screen. Upon verifying the credentials, the application loads the main application interface. Fortunately, the application checks whether the client supports cookies; therefore, any user with disabled&amp;nbsp;cookies will still be able to use the application. &lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;&amp;lt;%-- Filename: /myapp/index.jsp --%&amp;gt;&lt;br&gt;&amp;lt;%&lt;br&gt;// The application initiates a test that determines&lt;br&gt; &lt;br&gt;// whether cookies are enabledCookie&lt;br&gt; &lt;br&gt;testCookie = new Cookie(""myappTestCookie", "testVal");&lt;br&gt;testCookie.setMaxAge(300);&lt;br&gt;response.addCookie(testCookie);%&amp;gt;&lt;br&gt;&amp;lt;jsp:forward page="/myapp/login.jsp" /&amp;gt;&lt;br&gt; &lt;br&gt; &lt;br&gt;&amp;lt;%-- Filename: /myapp/login.jsp --%&amp;gt;&lt;br&gt;&amp;lt;html&amp;gt;&lt;br&gt;  &amp;lt;head&amp;gt;&lt;br&gt;    &amp;lt;title&amp;gt;::login&amp;lt;/title&amp;gt;&lt;br&gt;  &amp;lt;/head&amp;gt;&lt;br&gt;  &amp;lt;body&amp;gt;&lt;br&gt;    &amp;lt;form method="POST" action="https://login.example.com/myapp/auth"&amp;gt;&lt;br&gt;    &amp;lt;input type="text" name="user" size="20"&amp;gt;&lt;br&gt;    &amp;lt;br&amp;gt;&amp;lt;input type="password" name="pass" size="20"&amp;gt;&lt;br&gt;    &amp;lt;br&amp;gt;&amp;lt;input type="submit" value="log in"&amp;gt;&amp;lt;/form&amp;gt;&lt;br&gt;  &amp;lt;/body&amp;gt;&lt;br&gt;&amp;lt;/html&amp;gt;&lt;br&gt; &lt;br&gt; &lt;br&gt;/*  Filename: /myapp/auth  */&lt;br&gt;import java.io.*;&lt;br&gt;import java.util.*;&lt;br&gt;import javax.servlet.*;&lt;br&gt;import javax.servlet.http.*;&lt;br&gt; &lt;br&gt;public final class Auth extends HttpServlet{&lt;br&gt;      public void doGet(HttpServletRequest request,&lt;br&gt;              HttpServletResponse response) throws ServletException, IOException&lt;br&gt;      {&lt;br&gt;            HttpSession session = request.getSession(true);&lt;br&gt;            Cookie[] cookies = request.getCookies();&lt;br&gt;            String redirectURL = "/myapp/main";&lt;br&gt;            boolean cookiesSupported = true;&lt;br&gt; &lt;br&gt;            ...&lt;br&gt; &lt;br&gt;            // The application checks if the test cookie is accepted by the client&lt;br&gt;            if (cookies.length &amp;lt; 1)&lt;br&gt;            {&lt;br&gt;                  cookiesSupported = false;&lt;br&gt;            }&lt;br&gt; &lt;br&gt;            ...&lt;br&gt; &lt;br&gt;            if (!cookiesSupported)&lt;br&gt;            {&lt;br&gt;                  redirectURL = response.encodeURL(redirectURL);&lt;br&gt;            }&lt;br&gt; &lt;br&gt;            response.sendRedirect(redirectURL);&lt;br&gt;      }&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;For more information on HTTP sessions, see: Documentation for &lt;a href="http://download.oracle.com/javaee/1.3/api/javax/servlet/http/HttpSession.html"&gt;Interface HttpSession&lt;/a&gt; in Java SDK. &lt;/li&gt;&lt;li&gt;For more information on HTTP cookies, see: Documentation for &lt;a href="http://download.oracle.com/javaee/1.3/api/javax/servlet/http/Cookie.html"&gt;Class Cookie&lt;/a&gt; in Java SDK. &lt;/li&gt;&lt;li&gt;For more information on HTTP responses, see: Documentation for &lt;a href="http://download.oracle.com/javaee/1.3/api/javax/servlet/http/HttpServletResponse.html"&gt;Interface HttpServletResponse&lt;/a&gt; in Java SDK. &lt;/li&gt;&lt;li&gt;To learn more about session management, see: &lt;a href="http://www.securityfocus.com/infocus/1774"&gt;Basic Web Session Impersonation&lt;/a&gt;. &lt;/li&gt;&lt;li&gt;To learn more about session prediction attacks, see: &lt;a href="http://www.webappsec.org/projects/threat/classes/credential_session_prediction.shtml"&gt;Credential and Session Prediction&lt;/a&gt;.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:33D22944-96D4-4711-AE97-BD87A87463C9"&gt;Guideline: Do Not Place Sensitive Data in Parameters (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:3EB8979E-59F0-4C2B-8D8A-CFB173E5D66B"&gt;Attack: HTTP Session Hijacking Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:74F3AE96-F7AD-45A2-B8DE-008D23234123"&gt;Checklist Item: JSESSIONIDs are Stored in the URL When Cookies are Disabled (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>