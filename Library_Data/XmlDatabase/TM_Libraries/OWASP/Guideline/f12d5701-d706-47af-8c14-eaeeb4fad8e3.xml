<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="f12d5701-d706-47af-8c14-eaeeb4fad8e3" Author="" Category="Deployment Considerations" Priority="2" Rule_Type="Guideline" Status="" Technology="Java" title="Use a Secure Key Storage Location" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;Applies to&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Applications written using Servlets or JSP.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;What to Do&lt;/h1&gt;&lt;p&gt;Application keys should be stored in a well defined location, such as the Java KeyStore. Do not hard code them or store them as plaintext inside configuration files or source code.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;When faced with encryption, intruders attack the most vulnerable aspect: key management. Because keys are used to generate the encryption that protects sensitive data, the keys themselves become sensitive data that needs to be protected.&lt;/p&gt;&lt;h1&gt;When&lt;/h1&gt;&lt;p&gt;If your application uses encryption and encryption keys, use a secure storage location for the keys.&lt;/p&gt;&lt;h1&gt;How&lt;/h1&gt;&lt;p&gt;When considering a key storage location:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify the need for a key store. &lt;/strong&gt;Key stores should be used when your application utilizes crypto keys. Example:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;KeyGenerator kgen = KeyGenerator.getInstance("AES");&lt;br&gt;kgen.init(256);SecretKey skey = kgen.generateKey();&lt;br&gt;byte[] rawKey = skey.getEncoded();&lt;br&gt; SecretKeySpec skeySpec = new SecretKeySpec(rawKey, "AES");&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Use Java's KeyStore class. &lt;/strong&gt;Since version 1.2, Java offers a key store functionality as part of the Java Runtime Environment. The Java key store requires a master password for retrieving the contents of the key store. The master password should be given to the application at starting time. Use the KeyTool utility to create and manage the keys inside the key store. Example of accessing the key store:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;String keyStoreName = MyApp.getKeyStoreName();&lt;br&gt;char[] keyStorePass = MyApp.getKeyStorePass();&lt;br&gt; KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());&lt;br&gt;FileInputStream keyStoreFile = new FileInputStream(keyStoreName);&lt;br&gt;keyStore.load(keyStoreFile, keyStorePass);&lt;br&gt;keyStoreFile.close();&lt;br&gt; final String keyName = "MyAppEncryptionKey";&lt;br&gt;// Note: Although the example uses the same password for storing the KeyStore&lt;br&gt;// on disk and adding keys to the KeyStore, the 2 passwords can be different&lt;br&gt;// from one another&lt;br&gt;SecretKey skey = (SecretKey)keyStore.getKey(keyName, keyStorePass);&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Protect the key store.&lt;/strong&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Choose a key store directory&lt;/strong&gt;: Dedicate a directory for storing your application's key store files. Make sure the directory is not web-accessible. This limits the scope of users&amp;nbsp;who can potentially compromise the contents inside the directory. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Set appropriate permissions&lt;/strong&gt;: Apply filesystem permissions such that the key store files can be only accessed by your application and its administrators.&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Avoid common mistakes.&lt;/strong&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Do not hard-code keys in the application&lt;/strong&gt;: Hard-coding the encryption keys into the source code, hoping that an attacker will not reverse engineer the application, is security through obscurity. A determined attacker will usually find a way to defeat such a mechanism. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Do not place keys into configuration files&lt;/strong&gt;: Obfuscating the encryption keys and placing them into configuration files is security through obscurity. A determined attacker will usually find a way to defeat such a mechanism. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Unload keys from memory after their use&lt;/strong&gt;: Leaving the encryption keys in memory after their final use allows the operating system to page them from memory and onto the hard drive. A determined attacker will usually find a way to obtain the encryption keys from the operating system's page file.&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following code shows a hard-coded encryption key inside the application. A determined attacker will be able to compromise the key once they gain access to the source code.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;String encKey = "encryption key";&lt;br&gt;MessageDigest md = MessageDigest.getInstance("SHA-512");&lt;br&gt;md.update(encKey.getBytes("UTF-8"));&lt;br&gt;byte[] rawKey = md.digest();&lt;br&gt;md.reset();&lt;br&gt;SecretKeySpec skeySpec = new SecretKeySpec(rawKey, "AES");&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Solution Example&lt;/h1&gt;&lt;p&gt;The following code loads the encryption key from the Java key store. Because the key is properly stored, it is impossible for an attacker to steal the actual key without also stealing the master password.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;String keyStoreName = MyApp.getKeyStoreName();&lt;br&gt;char[] keyStorePass = MyApp.getKeyStorePass(); &lt;br&gt;KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());&lt;br&gt;FileInputStream keyStoreFile = new FileInputStream(keyStoreName);&lt;br&gt;keyStore.load(keyStoreFile, keyStorePass);&lt;br&gt;keyStoreFile.close();&lt;br&gt; final String keyName = "MyAppEncryptionKey";&lt;br&gt;// Note: Although the example uses the same password for storing the KeyStore&lt;br&gt;// on disk and adding keys to the KeyStore, the 2 passwords can be different &lt;br&gt;// from one another&lt;br&gt;SecretKey skey = (SecretKey)keyStore.getKey(keyName, keyStorePass);&lt;br&gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;To learn more about storing encryption keys using Java, see: Documentation for &lt;a href="http://download.oracle.com/javase/1.4.2/docs/api/java/security/KeyStore.html"&gt;Class KeyStore&lt;/a&gt; in Java SDK.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:3D160166-FAEE-4B86-8972-654DC341E322"&gt;Attack: Weak Keystore Protection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:3B657A67-F660-4DB5-9267-6E0FE2DAA1EB"&gt;Attack: Chosen Ciphertext Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:DEBB5734-39D0-4922-BDEE-1E0547E22DAD"&gt;Attack: Chosen Plaintext Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:24D078E3-A02F-4EDF-A6EA-DA0E3E5FFE5E"&gt;Attack: Key Bruteforce Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:E5D7DA05-EB59-46C5-AF9F-BA1B32C783CE"&gt;Guideline: Clear Sensitive Data from Memory when No Longer Used (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:EA0D0F4E-A363-4777-9F0D-91E8C5042F9C"&gt;Guideline: Do Not Store Plaintext Sensitive Data (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:197029DD-4692-45C7-8EFF-B0E8760479BC"&gt;Guideline: Protect Sensitive Data Inside Configuration Files (Java Web Application)&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>