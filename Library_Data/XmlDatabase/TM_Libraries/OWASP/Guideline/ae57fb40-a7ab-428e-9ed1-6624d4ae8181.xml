<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="ae57fb40-a7ab-428e-9ed1-6624d4ae8181" Author="" Category="Input and Data Validation" Priority="1" Rule_Type="Guideline" Status="" Technology="Java" title="Validate Input from All Sources" Topic="Security" phase="Design" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;Applies to&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Applications written using Servlets or JSP.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;What to Do&lt;/h1&gt;&lt;p&gt;Treat input from all external sources as untrusted and apply input validation techniques.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Input that is not validated can lead to cross-site scripting, SQL injection, directory traversals, and other vulnerabilities&amp;nbsp;that could allow an attacker to gain unauthorized access to sensitive data.&lt;/p&gt;&lt;h1&gt;When&lt;/h1&gt;&lt;p&gt;Treat all input as untrusted. If you have established trust boundaries for your application, then validate data every time it crosses a trust boundary.&lt;/p&gt;&lt;h1&gt;How&lt;/h1&gt;&lt;p&gt;An application can take input via various ways: web interface, database, file system, other software running on the server, etc. Use the following steps to establish a validation strategy:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Establish your application's trust boundary:&lt;/strong&gt; The notion is that all input not generated by your application is untrusted.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify all sources of input&lt;/strong&gt;: An application can have various sources of input and each one is an entry point to your application&amp;nbsp;that can potentially be used to break your application's security model. Enumerate all possible sources of input and make note of the expected input&amp;nbsp;at&amp;nbsp;each source. Potential sources of input in a web application typically include:&lt;/p&gt;&lt;/li&gt;&lt;ol&gt;&lt;li&gt;URL based parameters &lt;/li&gt;&lt;li&gt;Form based parameters &lt;/li&gt;&lt;li&gt;Hidden fields &lt;/li&gt;&lt;li&gt;Cookies &lt;/li&gt;&lt;li&gt;HTTP headers &lt;/li&gt;&lt;li&gt;Local filesystem &lt;/li&gt;&lt;li&gt;Database &lt;/li&gt;&lt;li&gt;Other related services&lt;/li&gt;&lt;/ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Understand the input that your application can handle and process&lt;/strong&gt;: After identifying the different entry points, define the format and type of input that&amp;nbsp;should be provided through each entry point. &lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Create a set of validators&lt;/strong&gt;: Build a validator for each format and type of expected input. Centralize your application's validators as it helps strengthen the code by limiting the amount of scattered validation code throughout your application. Place the set of validators on your application's trust boundary. Your application should accept input from the outside world only through its set of validators. &lt;/p&gt;&lt;p&gt;See the &lt;a href="ruledisplay:DA8CCFC9-F04F-4913-B05E-F574D3E4A559"&gt;Validate Input for Length, Range, Format, and Type&lt;/a&gt; guideline for more information on constructing validation routines.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following code produces a data analysis based on a financial index. Unfortunately, the application validates the user's input but not the returned data from the database. Therefore, the application is vulnerable to an integer overflow that can harm the business logic used in generating the data analysis.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;import java.io.*;&lt;br&gt;import java.util.*;&lt;br&gt;import java.lang.*;&lt;br&gt;import javax.servlet.*;&lt;br&gt;import javax.servlet.http.*;&lt;br&gt;import java.util.regex.*;&lt;br&gt; public final class DataAggregator extends HttpServlet&lt;br&gt;{      public void doGet(HttpServletRequest request, HttpServletResponse response)&lt;br&gt;            throws ServletException, IOException&lt;br&gt;      {            PrintWriter out = response.getWriter();&lt;br&gt;            String searchTerm = request.getParameter("index");&lt;br&gt;             try&lt;br&gt;            {&lt;br&gt;                  // The application validates the user-supplied input&lt;br&gt;                  if (validateSearchTerm(searchTerm))&lt;br&gt;                  {&lt;br&gt;                        String retString;&lt;br&gt;                         retString = "The queried index \"";&lt;br&gt;                        retString += encodeHtml(searchTerm);&lt;br&gt;                        retString += "\" produced the following results:&amp;lt;br&amp;gt; ";&lt;br&gt;                        out.println(retString);&lt;br&gt;                        aggregateData(out, searchTerm);&lt;br&gt;                  }&lt;br&gt;                  else&lt;br&gt;                  {&lt;br&gt;                        // Add the appropriate logging and exception handling&lt;br&gt;                        // mechanisms. Consult the Exception Handling and&lt;br&gt;                         // Logging sections&lt;br&gt;                         out.println("We cannot handle your request at the moment."&lt;br&gt;                                 + " Please try again later.");&lt;br&gt;                  }&lt;br&gt;            }&lt;br&gt;             catch (Exception e)&lt;br&gt;            {&lt;br&gt;                  // Add the appropriate logging and exception handling&lt;br&gt;                   // mechanisms. Consult the Exception Handling and&lt;br&gt;                   // Logging sections &lt;br&gt;                  out.println("We cannot handle your request at the moment."&lt;br&gt;                           + " Please try again later.");&lt;br&gt;            }&lt;br&gt;             out.flush();&lt;br&gt;            out.close();&lt;br&gt;      }&lt;br&gt;       boolean validateSearchTerm(String input)&lt;br&gt;      {&lt;br&gt;            String goodPattern = "(\\w|\\d)+";&lt;br&gt;            int goodLength = 8;&lt;br&gt;             if (input == null)&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;             if(input.length() &amp;gt; goodLength)&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;                        Pattern p = Pattern.compile(goodPattern);&lt;br&gt;            Matcher m = p.matcher(input);&lt;br&gt;                        if(!m.matches())&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;                        return true;&lt;br&gt;      }&lt;br&gt;       void aggregateData(PrintWriter out, String searchTerm)&lt;br&gt;      {&lt;br&gt;            double[] rData = common.queryDBForIndex(searchTerm);&lt;br&gt;             // The application fails to validate the returned&lt;br&gt;             // data from the database&lt;br&gt;             // Business logic that performs certain data analysis&lt;br&gt;      }&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Solution Example&lt;/h1&gt;&lt;p&gt;The following code produces a data analysis based on a financial index. Since the code validates all sources of input to the application, the application is secured from SQL injection and integer overflows. Notice that this example code is also related to &lt;a href="ruledisplay:c98695c5-cf02-44a1-96bf-1f8046b8ad9d"&gt;Validate Input for Length, Range, Format, and Type&lt;/a&gt;.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;import java.io.*;&lt;br&gt;import java.util.*;&lt;br&gt;import java.lang.*;&lt;br&gt;import javax.servlet.*;&lt;br&gt;import javax.servlet.http.*;&lt;br&gt;import java.util.regex.*;&lt;br&gt; public final class DataAggregator extends HttpServlet&lt;br&gt;{      public void doGet(HttpServletRequest request, HttpServletResponse response)&lt;br&gt;            throws ServletException, IOException&lt;br&gt;      {&lt;br&gt;            PrintWriter out = response.getWriter();&lt;br&gt;            String searchTerm = request.getParameter("index");&lt;br&gt;             try&lt;br&gt;            {&lt;br&gt;                  // The application validates the user-supplied input&lt;br&gt;                  if (validateSearchTerm(searchTerm))&lt;br&gt;                  {&lt;br&gt;                        String retString;&lt;br&gt;                         retString = "The queried index \"";&lt;br&gt;                        retString += encodeHtml(searchTerm);&lt;br&gt;                        retString += "\" produced the following results:&amp;lt;br&amp;gt; ";&lt;br&gt;                        out.println(retString);&lt;br&gt;                        aggregateData(out, searchTerm);&lt;br&gt;                  }&lt;br&gt;                  else&lt;br&gt;                  {&lt;br&gt;                        // Add the appropriate logging and exception&lt;br&gt;                        // handling mechanisms. Consult the Exception Handling&lt;br&gt;                        // and Logging sections &lt;br&gt;                        out.println("We cannot handle your request at the moment."&lt;br&gt;                                 + " Please try again later.");&lt;br&gt;                  }&lt;br&gt;            }&lt;br&gt;             catch (Exception e)&lt;br&gt;            {&lt;br&gt;                  // Add the appropriate logging and exception handling mechanisms&lt;br&gt;                  // Consult the Exception Handling and Logging sections&lt;br&gt;                   out.println("We cannot handle your request at the moment."&lt;br&gt;                           + " Please try again later.");&lt;br&gt;            }&lt;br&gt;             out.flush();&lt;br&gt;            out.close();&lt;br&gt;      }&lt;br&gt;       void aggregateData(PrintWriter out, String searchTerm) throws Exception&lt;br&gt;      {&lt;br&gt;            double[] rData = common.queryDBForIndex(searchTerm);&lt;br&gt;             // The application validates the returned data from the database&lt;br&gt;            if (validateRawDBData(rData))&lt;br&gt;            {&lt;br&gt;                  // Business logic that performs certain data analysis&lt;br&gt;            }&lt;br&gt;            else&lt;br&gt;            {&lt;br&gt;                  String errMsg = "Business logic not executed";&lt;br&gt;                  throw new Exception(errMsg);&lt;br&gt;            }&lt;br&gt;      }&lt;br&gt;       boolean validateSearchTerm(String input)&lt;br&gt;      {&lt;br&gt;            String goodPattern = "(\\w|\\d)+";&lt;br&gt;            int goodLength = 8;&lt;br&gt;             if (input == null)&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;             if(input.length() &amp;gt; goodLength)&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;                        Pattern p = Pattern.compile(goodPattern);&lt;br&gt;            Matcher m = p.matcher(input);&lt;br&gt;                        if(!m.matches())&lt;br&gt;            {&lt;br&gt;                  return false;&lt;br&gt;            }&lt;br&gt;                        return true;&lt;br&gt;      }&lt;br&gt;       boolean validateRawDBData(double[] input)&lt;br&gt;      {&lt;br&gt;            boolean valid = true;&lt;br&gt;             for (int i = 0; i &amp;lt; input.length; i++)&lt;br&gt;            {&lt;br&gt;                  if (input[i] &amp;lt; 0.0 || input[i] &amp;gt; 100.0)&lt;br&gt;                  {&lt;br&gt;                        valid = false;&lt;br&gt;                  }&lt;br&gt;            }&lt;br&gt;             return valid;&lt;br&gt;      }&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:DA8CCFC9-F04F-4913-B05E-F574D3E4A559"&gt;Guideline: Validate Input for Length, Range, Format, and Type (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:BEC58471-A0EF-40C5-8C9D-9BF5C4B91F1F"&gt;Guideline: Filter All User-Supplied Filename and Path Input (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:2D8158D1-E2D1-459F-9BD7-56D4B979EFE3"&gt;Guideline: Encode All Output Data (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:D6593992-DC9E-42C5-9E98-30E8EF075B93"&gt;Guideline: Do Not Rely on Client-Side Validation (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:81491E66-67B7-49F3-BDA6-4B4C9245C702"&gt;Guideline: Validate All Input Passed to Database (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:D8D7FC19-F935-4FA1-BB66-8D4B8A185CDB"&gt;Guideline: Validate User's Login Credentials Before Processing Them (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:42F599F0-D1D6-4F25-9CC2-D5473F19113F"&gt;Guideline: Validate All Data Passed Between Native and Java Code (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:178EB28D-4F49-4476-AE8A-437F966DE577"&gt;Checklist Item: Input from All Sources is Validated (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>