<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="4471ff4d-d052-4fe2-afd9-1c57a4bc0273" Author="" Category="Data Access" Priority="1" Rule_Type="Guideline" Status="" Technology="ASP.NET 3.5" title="Use Stored Procedures" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Do&lt;/h1&gt;&lt;p&gt;Always use stored procedures when interacting with a database. This increases performance and reduces the risk of a successful SQL injection attack.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Attackers can use a &lt;a href="ruledisplay:1D4FA7AF-33F0-40D9-9665-A31DBF3D7764"&gt;SQL Injection Attack&lt;/a&gt; to manipulate the database in unforeseen ways. SQL injection allows an attacker to assume the credentials of the SQL account used to connect to the database, which may lead to arbitrary reading, writing, updating, or deleting of data. In an improperly secured database this can also lead to remote code execution through the use of certain stored procedures that allow for direct Operating System command injection.&lt;/p&gt;&lt;h1&gt;When&lt;/h1&gt;&lt;p&gt;Whenever interaction with a database is required&lt;/p&gt;&lt;h1&gt;How&lt;/h1&gt;&lt;p&gt;First the stored procedure will have to be created on the database, this can be done using the following SQL syntax:&lt;/p&gt;&lt;pre&gt;CREATE PROCEDURE &lt;br&gt;sp_AddNewUser( @UserName nvarchar(255), @Email  nvarchar(255), &lt;br&gt;@FirstName nvarchar(255), @LastName nvarchar(255)) AS&lt;/pre&gt;&lt;pre&gt;-- INSERT the new user&lt;br&gt;INSERT INTO Users_Table(UserName, Email, FirstName, LastName)&lt;br&gt;VALUES(@UserName, @Email, @FirstName, @LastName)&lt;br&gt;--This will return the new user’s IDSELECT SCOPE_IDENTITY()&lt;/pre&gt;&lt;p&gt;Now to call the stored procedure we can use the following .NET code:&lt;/p&gt;&lt;pre&gt;//create a new connection using our connection string&lt;br&gt;SqlConnection myConnection = new SqlConnection(connection string)&lt;br&gt;;myConnection.Open();&lt;br&gt;//create a new command that specifies our store procedure&lt;br&gt;SqlCommand myCommand = new SqlCommand("sp_AddNewUser", myConnection);&lt;br&gt;//Specify our command is a stored proceduremy&lt;br&gt;Command.CommandType = Command&lt;br&gt;Type.StoredProcedure;&lt;br&gt;//Create a new parameter to carry the username&lt;br&gt;SqlParameter UserParameter = new SqlParameter("@UserName", SqlDbType.VarChar);&lt;br&gt;UserParameter.Direction = ParameterDirection.Input;&lt;br&gt;UserParameter.Value = "TestUser";&lt;br&gt;//Add the parameter to the command&lt;br&gt;myCommand.Parameters.Add(UserParameter);&lt;br&gt;//Repeat this code to add commands for each parameter in the SPROC&lt;br&gt;//Execute the command on the Database&lt;br&gt;myCommand.ExecuteNonQuery();&lt;/pre&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;There are many ways to create a SQL injection vulnerability, and it’s even possible to do using stored procedures. The vulnerability lies in dynamically creating a SQL statement without bound parameters. In the following example the developer has built the SELECT statement by appending the components of the statements together with user provided input.&lt;/p&gt;&lt;p&gt;The developer wants to execute the following command where [username] is the username of the user whose e-mail we would like to return&lt;/p&gt;&lt;pre&gt;SELECT Email from Users_Table where &lt;br&gt;UserName = [username];&lt;br&gt;&lt;/pre&gt;&lt;pre&gt;The following code will create that statement an execute it on the database:&lt;br&gt;//create a new connection using our connection string&lt;br&gt;SqlConnection myConnection = new SqlConnection(connection string);&lt;br&gt;myConnection.Open();&lt;br&gt;//create a new command that specifies our store procedure&lt;br&gt;string selectCommand = "SELECT Email from Users_Table WHERE UserName = "&lt;br&gt;         + userNameBox.Text;&lt;br&gt;SqlCommand myCommand = new SqlCommand(selectCommand);&lt;br&gt;//Execute the command on the Database&lt;br&gt;SqlDataReader myReader = myCommand.ExecuteReader();&lt;/pre&gt;&lt;h1&gt;Solution Example&lt;/h1&gt;&lt;p&gt;First a stored procedure needs to be created on the database, the following SQL syntax can be used to create the same select statement as above:&lt;/p&gt;&lt;pre&gt;CREATE PROCEDURE sp_ReturnEmail( @UserName nvarchar(255)) &lt;br&gt;ASSELECT Email FROM Users_Table where UserName = @UserName;&lt;/pre&gt;&lt;p&gt;Now the following code can be used to query the database using the stored procedure:&lt;/p&gt;&lt;pre&gt;//create a new connection using our connection string&lt;br&gt;SqlConnection myConnection = new SqlConnection(connection string);&lt;br&gt;myConnection.Open();&lt;br&gt;//create a new command that specifies our store procedure&lt;br&gt;SqlCommand myCommand = new SqlCommand("sp_ReturnEmail", myConnection);&lt;br&gt;//Specify our command is a stored procedure&lt;br&gt;myCommand.CommandType = CommandType.StoredProcedure;&lt;br&gt;//Create a new parameter to carry the username&lt;br&gt;SqlParameter UserParameter = new SqlParameter("@UserName", SqlDbType.VarChar);U&lt;br&gt;serParameter.Direction = ParameterDirection.Input;UserParameter.Value = [username];&lt;br&gt;//Add the parameter to the command&lt;br&gt;myCommand.Parameters.Add(UserParameter);&lt;br&gt;//Execute the command on the Database&lt;br&gt;SqlDataReader myReader = myCommand.ExecuteReader();&lt;/pre&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;To learn more about stored procedures, visit: &lt;a href="http://en.wikipedia.org/wiki/Stored_procedure"&gt;Stored procedure&lt;/a&gt;. &lt;/li&gt;&lt;li&gt;For more information on using stored procedures, visit: &lt;a href="http://aspnet.4guysfromrolla.com/articles/062905-1.aspx"&gt;Returning a Scalar value from a Stored Procedure&lt;/a&gt;.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:3437DF81-6B8C-4A14-BB6E-34F6EE21C45F"&gt;Guideline: Use Type Safe SQL Parameters When Constructing SQL Queries &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:F1B74837-9A72-4745-A149-EC5D8C476EB7"&gt;Guideline: Validate All Input Passed to Database&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:1D4FA7AF-33F0-40D9-9665-A31DBF3D7764"&gt;Attack: SQL Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:8515588C-661A-4962-853F-6CD6ABCD8CF6"&gt;Attack: Server-Side Code Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:22BE1EE0-7DA4-4571-8D58-3ED211A05947"&gt;Checklist Item: Type Safe SQL Parameters are Used &lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;p&gt;Adapted from Microsoft patterns &amp;amp; practices guidance.&lt;/p&gt;</content>
</guidanceItem>