<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="500a3e89-2937-41b8-99cc-a19dc7696ed6" Author="" Category="Authorization" Priority="2" Rule_Type="Guideline" Status="" Technology="ASP.NET 3.5" title="Perform Role-based Security Checks" Topic="Security" phase="Design" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Do&lt;/h1&gt;&lt;p&gt;Enumerate the different types of users and create specific roles for them. When authorizing access to a resource, build the security checks on a per-role basis rather than on a per-user basis.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Application roles allow administrators to group users into categories that need the same level of privileges. The mechanism provides an easy and clear way to discover and manage the least privileges necessary for the execution of a given task. It provides a more robust and flexible way of managing the application's users.&lt;/p&gt;&lt;h1&gt;When&lt;/h1&gt;&lt;p&gt;If your application uses access control and authorizes its users to application resources.&lt;/p&gt;&lt;h1&gt;How&lt;/h1&gt;&lt;p&gt;To apply this concept access control should be based on a user's role rather than the actual user.&lt;/p&gt;&lt;p&gt;Use the following steps when designing the role-based security:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Understand the different types of users&lt;/strong&gt;: Enumerate the different types of users needed for the application. Understand how they willl use the application and to which resources they will need access. Create a matrix mapping the actions each role is authorized to perform with the corresponding system components. Use this matrix to identify the different types of users according to the functionality they need. Creating a threat model may be a useful step to ensure that you correctly understand the implications of this matrix.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Establish the roles&lt;/strong&gt;: Define which resources can be accessed by each role. There are two approaches when enforcing role-based security - programmatic and declarative.&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Programmatically&lt;/strong&gt;: The programmatic approach to role-based security is written inside the code and provides additional runtime flexibility. It allows your application to dynamically create and assign roles so that user privileges can be granted and revoked without the need of restarting your application. When using the programmatic approach to role-based security, place access control checks at the appropriate locations in your application. For example, the following code requires users to be shareholders in order to generate a financial report:&lt;/p&gt;&lt;pre&gt;public void GenerateFinancialReport(DateTime startDate, DateTime endDate)&lt;br&gt;{&lt;br&gt;    if (HttpContext.Current.User.IsInRole("ShareHolders"))&lt;br&gt;    {&lt;br&gt;        // Generate the relevant financial report&lt;br&gt;    }&lt;br&gt;}&lt;/pre&gt;&lt;p&gt;Additionally, your application can programmatically check if a user is member of a local Windows group.&lt;/p&gt;&lt;pre&gt;public void RetrieveLogs(ref Hashtable logTable)&lt;br&gt;{&lt;br&gt;    WindowsPrincipal user = new WindowsPrincipal((WindowsIdentity)HttpContext.Current.User.Identity);&lt;br&gt;    if (user.IsInRole(WindowsBuiltInRole.Administrator))&lt;br&gt;    {&lt;br&gt;        // Add logic for retrieving logs&lt;br&gt;    }&lt;br&gt;}&lt;/pre&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Declarative&lt;/strong&gt;: The declarative approach to role-based security is done via the configuration files. It allows easy manageability as the declarations can be modified without having to recompile. By using the declarative approach, you can easily manage the security settings for large portions of the application without changing the source code. ASP.NET applications that use declarative security specify the appropriate roles inside &lt;strong&gt;web.config&lt;/strong&gt;. The following elements enforce role-based security through &lt;strong&gt;web.config&lt;/strong&gt;:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;roleManager&lt;/strong&gt;: Configures the ASP.NET role manager. Applicable only if form-based authentication is used. Example:&lt;/p&gt;&lt;pre&gt;&amp;lt;connectionStrings&amp;gt;&lt;br&gt;  &amp;lt;add name="MyAppSqlConnection"&lt;br&gt;       connectionString="Server=serv02.example.com; Database=myapp; Integrated Security=SSPI;"&lt;br&gt;       providerName="System.Data.SqlClient"/&amp;gt;&lt;br&gt; ...&lt;br&gt; &amp;lt;system.web&amp;gt;&lt;br&gt;   &amp;lt;roleManager enabled="true" cacheRolesInCookie="false" defaultProvider ="ProjectRoleProvider"&amp;gt;&lt;br&gt;    &amp;lt;providers&amp;gt;&lt;br&gt;      &amp;lt;clear /&amp;gt;&lt;br&gt;      &amp;lt;add name="MyAppRoleProvider"&lt;br&gt;            type="System.Web.Security.SqlRoleProvider"&lt;br&gt;            connectionStringName="MyAppSqlConnection"&lt;br&gt;            applicationName="MyApp"/&amp;gt;&lt;/pre&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;authorization&lt;/strong&gt;: Encapsulates the authorization settings for a resource.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;allow&lt;/strong&gt;: Represents the users and roles that are allowed access to the given resource.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;deny&lt;/strong&gt;: Represents the users and roles that are denied access to the given resource.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;For example:&lt;/p&gt;&lt;pre&gt;&amp;lt;!-- web.config --&amp;gt;&lt;br&gt;&amp;lt;system.web&amp;gt;&lt;br&gt;   &amp;lt;authentication mode="Windows" /&amp;gt;&lt;br&gt;   &amp;lt;authorization&amp;gt;&lt;br&gt;    &amp;lt;allow roles="BUILTIN\Administrators"/&amp;gt;&lt;br&gt;    &amp;lt;deny users="*"/&amp;gt;&lt;br&gt;  &amp;lt;/authorization&amp;gt;&lt;br&gt;&amp;lt;/system.web&amp;gt;&lt;/pre&gt;&lt;p&gt;Additionally, if your application uses form-based authentication, you can configure your application's access controls through Visual Studio's ASP.NET Configuration, available by accessing the &lt;strong&gt;Website -&amp;gt; ASP.NET Configuration&lt;/strong&gt; menu.&lt;/p&gt;&lt;p&gt;Note that if you use Windows authentication, you will need to manage your application's users and user roles through managing Windows users and groups.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Manage the users&lt;/strong&gt;: Assign the users into their respective user roles. The application should enforce the security policy according to the user roles instead of the actual user. Based on your application's mechanism to enforce role-based access controls, use one of the following techniques to manage your application's users:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Programmatically&lt;/strong&gt;: ASP.NET allows you to manage your application's users through the &lt;strong&gt;Roles&lt;/strong&gt; class.&lt;/p&gt;&lt;p&gt;Use the following methods to assign users into roles:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;AddUserToRole&lt;/strong&gt; &lt;/li&gt;&lt;li&gt;&lt;strong&gt;AddUserToRoles&lt;/strong&gt; &lt;/li&gt;&lt;li&gt;&lt;strong&gt;AddUsersToRole&lt;/strong&gt; &lt;/li&gt;&lt;li&gt;&lt;strong&gt;AddUsersToRoles&lt;/strong&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Example:&lt;/p&gt;&lt;pre&gt;Roles.AddUserToRole("eric", "ShareHolders");&lt;/pre&gt;&lt;p&gt;Use the following methods to remove users from roles:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;RemoveUserFromRole&lt;/strong&gt; &lt;/li&gt;&lt;li&gt;&lt;strong&gt;RemoveUserFromRoles&lt;/strong&gt; &lt;/li&gt;&lt;li&gt;&lt;strong&gt;RemoveUsersFromRole&lt;/strong&gt; &lt;/li&gt;&lt;li&gt;&lt;strong&gt;RemoveUsersFromRoles&lt;/strong&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Example:&lt;/p&gt;&lt;pre&gt;Roles.RemoveUserFromRole("eric", "ShareHolders");&lt;/pre&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Declarative&lt;/strong&gt;: Use the ASP.NET Role Manager to manage your application's users. If your application uses form-based authentication, you can configure your application's access controls through Visual Studio's ASP.NET Configuration, available by accessing the &lt;strong&gt;Website -&amp;gt; ASP.NET Configuration&lt;/strong&gt; menu.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Windows&lt;/strong&gt;: If your application uses Windows authentication, use the Windows &lt;strong&gt;Local Users and Groups&lt;/strong&gt; service to manage your application's users. If your server is connected to your organization's NT Domain or Active Directory forest, user and role management will be performed by your organization's network administrators.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following segment illustrates an application's access control policy. Because the application does not enforce role-based security, it has a policy entry for each separate user; therefore managing the users' access rights can be quite difficult when the number of users to the application grows.&lt;/p&gt;&lt;pre&gt;&amp;lt;authorization&amp;gt;&lt;br&gt;  &amp;lt;allow users="NTDomain\joe, NTDomain\sarah, NTDomain\bill, NTDomain\sue"/&amp;gt;&lt;br&gt;  &amp;lt;deny users="*"/&amp;gt;&lt;br&gt;&amp;lt;/authorization&amp;gt;&lt;/pre&gt;&lt;h1&gt;Solution Example&lt;/h1&gt;&lt;p&gt;The following segment illustrates an application's access control policy. Because the application enforces role-based security, it provides a policy entry for each group of users; therefore increasing the application's users store has no impact on the ability to manage the users' access rights as only the group permissions need to be modified.&lt;/p&gt;&lt;pre&gt;&amp;lt;authorization&amp;gt;&lt;br&gt;  &amp;lt;allow roles="NTDomain\Employees"/&amp;gt;&lt;br&gt;  &amp;lt;deny users="*"/&amp;gt;&lt;br&gt;&amp;lt;/authorization&amp;gt;&lt;/pre&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;To learn more about the roleManager element in web.config, visit: Documentation for &lt;a href="http://msdn2.microsoft.com/en-us/library/ms164660(vs.80).aspx"&gt;roleManager Element&lt;/a&gt; in MSDN.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:610BAA36-8A3C-404D-81D8-403ED054FEC4"&gt;Guideline: Partition Application Between Public and Private Domains &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:3E8C3E82-D02C-4322-87F6-0D2F0FA55DD2"&gt;Guideline: Partition Application Between Public and Private Domains&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:14FBF85D-0E97-4CD1-A0EE-D5AA791FA45C"&gt;Guideline: Define a Security Policy &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:FC9AF70F-092C-4AC6-9B54-6793DE17B8DD"&gt;Attack: Business Rule Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:AE79E2C4-186C-47E4-8D05-3C6ECAB2E1AF"&gt;Checklist Item: Role-Based Security Checks are Performed &lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;p&gt;Adapted from Microsoft patterns &amp;amp; practices guidance. &lt;/p&gt;</content>
</guidanceItem>