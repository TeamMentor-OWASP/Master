<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="4880b800-8273-4ef5-b094-efa3d09e6e10" Author="" Category="Input and Data Validation" Priority="2" Rule_Type="Guideline" Status="" Technology="Java" title="Encode All Output Data" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;Applies to&lt;/h1&gt;&lt;p&gt;Applications written using Servlets or JSP.&lt;/p&gt;&lt;h1&gt;What to Do&lt;/h1&gt;&lt;p&gt;Encode all input that is displayed back to the user.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Encoding echoed input prevents injection attacks such as cross-site scripting.&lt;/p&gt;&lt;h1&gt;When&lt;/h1&gt;&lt;p&gt;If user input will be echoed back to the client in any way, encode it first. This includes input that is immediately echoed back as well as input that is stored first (such as in a database) before being echoed back later.&lt;/p&gt;&lt;h1&gt;How&lt;/h1&gt;&lt;p&gt;Encoding the echoed user input prevents injection attacks such as cross-site scripting. Use the following steps to ensure all echoed input is encoded:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify all echoed input. &lt;/strong&gt;Locate all places inside your application where user-supplied data will be returned to the client. Such data can be of reflective or persistent nature:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Reflective&lt;/strong&gt;: In a reflective setting, the input is immediately returned to the client. For example, search engines present the searched query when displaying the results. &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Persistent&lt;/strong&gt;: In a persistent setting, the input is stored and returned to the client at a different stage in your application. For example, message boards store the users' posts inside a database and return them when a given topic is viewed.&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Determine the&amp;nbsp;type of encoding. &lt;/strong&gt;After identifying all echoed input, determine how the input is returned to client. Because input can take the form of HTML content or URLs, your application needs to use different encoding techniques:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;URL encoding&lt;/strong&gt;: URL encoding allows your application to maintain the original URL, yet display it to the user in a non-malicious way. Because HTTP headers allow a substitution schema, all characters/symbols are preserved by displaying their ASCII codes instead of the actual character/symbol. For example, &lt;strong&gt;&amp;lt;&lt;/strong&gt; is represented by &lt;strong&gt;%3C&lt;/strong&gt; where &lt;strong&gt;3C&lt;/strong&gt; is the ASCII value for &lt;strong&gt;&amp;lt;&lt;/strong&gt;:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;String encodedUrl = URLEncoder.encode(url);&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;HTML encoding&lt;/strong&gt;: HTML encoding is used when the echoed input is returned as regular text or HTML content. Input should be encoded by substituting certain characters with their respective HTML values:&lt;/p&gt;&lt;blockquote&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;Character&lt;/td&gt;&lt;td&gt;HTML value&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&amp;lt;&lt;/td&gt;&lt;td&gt;&amp;amp;lt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&amp;gt;&lt;/td&gt;&lt;td&gt;&amp;amp;gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&amp;amp;&lt;/td&gt;&lt;td&gt;&amp;amp;amp;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;"&lt;/td&gt;&lt;td&gt;&amp;amp;quot;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/blockquote&gt;&lt;p&gt;JSP can also HTML encode a string through the use of &lt;strong&gt;{ }&lt;/strong&gt; around the variable. &lt;strong&gt;{ }&lt;/strong&gt; invoke JSP's built-in HTML encoder which takes the variable between the brackets as its input. Example: &lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;&amp;lt;%= {output} %&amp;gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Apply the encoding. &lt;/strong&gt;After identifying the echoed input and determining the appropriate encoding method, apply the encoding before the input is returned to the client.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following code produces a data analysis based on a financial index. Because it does not HTML encode the echoed input, the application is vulnerable to reflective cross-site scripting.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;import java.io.*;&lt;br&gt;import java.util.*;&lt;br&gt;import java.lang.*;&lt;br&gt;import javax.servlet.*;&lt;br&gt;import javax.servlet.http.*;&lt;br&gt;import java.util.regex.*;&lt;br&gt; public final class DataAggregator extends HttpServlet&lt;br&gt;{&lt;br&gt;      public void doGet&lt;br&gt;             (&lt;br&gt;            HttpServletRequest request,&lt;br&gt;             HttpServletResponse response&lt;br&gt;            )&lt;br&gt;            throws ServletException, IOException&lt;br&gt;      {&lt;br&gt;            PrintWriter out = response.getWriter();&lt;br&gt;            String searchTerm = request.getParameter("index");&lt;br&gt;             try&lt;br&gt;            {&lt;br&gt;                  if (validateSearchTerm(searchTerm))&lt;br&gt;                  {&lt;br&gt;                        String retString;&lt;br&gt;                         retString = "The queried index \"";&lt;br&gt;                         // The application does not HTML encode&lt;br&gt;                         //     the returned input&lt;br&gt;                        retString += searchTerm;&lt;br&gt;                         retString += "\" results in:&amp;lt;br&amp;gt; ";&lt;br&gt;                        out.println(retString);&lt;br&gt;                        common.aggregateData(out, searchTerm);&lt;br&gt;                  }&lt;br&gt;                  else&lt;br&gt;                  {&lt;br&gt;                        // Add appropriate logging and exception handling&lt;br&gt;                         // mechanisms. Consult the Exception Handling and&lt;br&gt;                         // Logging sections&lt;br&gt;                         out.println("Unable to process at the moment."&lt;br&gt;                                 + " Please try again later.");&lt;br&gt;                  }&lt;br&gt;            }&lt;br&gt;             catch (Exception e)&lt;br&gt;            {&lt;br&gt;                  // Add the appropriate logging and exception handling&lt;br&gt;                   // mechanisms. Consult the Exception Handling&lt;br&gt;                   // and Logging sections&lt;br&gt;                   out.println("Unable to process at the moment."&lt;br&gt;                           + " Please try again later.");&lt;br&gt;            }&lt;br&gt;             out.flush();&lt;br&gt;            out.close();&lt;br&gt;      }&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Solution Example&lt;/h1&gt;&lt;p&gt;The following code produces a data analysis based on a financial index. Because the code HTML encodes the echoed input, it is impossible for an attacker to exploit the application via reflective cross-site scripting.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;import java.io.*;&lt;br&gt;import java.util.*;&lt;br&gt;import java.lang.*;&lt;br&gt;import javax.servlet.*;&lt;br&gt;import javax.servlet.http.*;&lt;br&gt;import java.util.regex.*;&lt;br&gt; public final class DataAggregator extends HttpServlet&lt;br&gt;{&lt;br&gt;      public void doGet&lt;br&gt;      (&lt;br&gt;        HttpServletRequest request,&lt;br&gt;         HttpServletResponse response&lt;br&gt;      )&lt;br&gt;            throws ServletException, IOException&lt;br&gt;      {&lt;br&gt;            PrintWriter out = response.getWriter();&lt;br&gt;            String searchTerm = request.getParameter("index");&lt;br&gt;             try&lt;br&gt;            {&lt;br&gt;                  if (validateSearchTerm(searchTerm))&lt;br&gt;                  {&lt;br&gt;                        String retString;&lt;br&gt;                         retString = "The queried index \"";&lt;br&gt;                         // The application HTML encodes the echoed input&lt;br&gt;                        retString += encodeHtml(searchTerm);&lt;br&gt;                         retString += "\" results in :&amp;lt;br&amp;gt; ";&lt;br&gt;                        out.println(retString);&lt;br&gt;                        common.aggregateData(out, searchTerm);&lt;br&gt;                  }&lt;br&gt;                  else&lt;br&gt;                  {&lt;br&gt;                        // Add the appropriate logging and exception&lt;br&gt;                         // handling mechanisms. Consult the Exception&lt;br&gt;                         // Handling and Logging sections&lt;br&gt;                         out.println("Unable to process at the moment."&lt;br&gt;                                 + " Please try again later.");&lt;br&gt;                  }&lt;br&gt;            }&lt;br&gt;            catch (Exception e)&lt;br&gt;            {&lt;br&gt;                  // Add the appropriate logging and exception&lt;br&gt;                   // handling mechanisms. Consult the Exception&lt;br&gt;                   // Handling and Logging sections&lt;br&gt;                   out.println("Unable to process at the moment."&lt;br&gt;                           + " Please try again later.");&lt;br&gt;            }             out.flush();&lt;br&gt;            out.close();&lt;br&gt;      }&lt;br&gt;       public String encodeHtml(String input)&lt;br&gt;      {&lt;br&gt;            StringBuffer out = new StringBuffer();&lt;br&gt;             for (int i = 0; i &amp;lt; input.length(); i++)&lt;br&gt;            {&lt;br&gt;                  char c = input.charAt(i);&lt;br&gt;                  if (c == '&amp;lt;')&lt;br&gt;                  {&lt;br&gt;                        out.append("&amp;amp;lt;");&lt;br&gt;                  }&lt;br&gt;                  else if (c == '&amp;gt;')&lt;br&gt;                  {&lt;br&gt;                        out.append("&amp;amp;gt;");&lt;br&gt;                  }&lt;br&gt;                  else if (c == '\"')&lt;br&gt;                  {&lt;br&gt;                        out.append("&amp;amp;quot;");&lt;br&gt;                  }&lt;br&gt;                  else if (c == '\'')&lt;br&gt;                  {&lt;br&gt;                        out.append("&amp;amp;quot;");&lt;br&gt;                  }&lt;br&gt;                  else if (c == '&amp;amp;')&lt;br&gt;                  {&lt;br&gt;                        out.append("&amp;amp;amp;");&lt;br&gt;                  }&lt;br&gt;                  else if (c &amp;gt; 0x20 &amp;amp;&amp;amp; c &amp;lt; 0x126)&lt;br&gt;                  {&lt;br&gt;                        out.append(c);&lt;br&gt;                  }&lt;br&gt;                  else&lt;br&gt;                  {&lt;br&gt;                        out.append("&amp;amp;#" + (int)c + ";");&lt;br&gt;                  }&lt;br&gt;            }&lt;br&gt;             return out.toString();&lt;br&gt;      }&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;To learn more about preventing cross-site scripting, see: &lt;a href="http://support.microsoft.com/kb/252985"&gt;How to prevent cross-site scripting security issues&lt;/a&gt;.&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:BC10DCE2-CA48-44BF-8BF6-FEFBE8DCCB7E"&gt;Attack: Cross Site Scripting Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:2B17E816-C6C4-4B05-BE92-01DC71073F66"&gt;Attack: Response Splitting Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:198CBDAF-3F87-4291-870D-8B6F077D8D36"&gt;Attack: AJAX Injection Attack&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:D4DBB48C-D394-4632-B72F-148BCD87E9D9"&gt;Checklist Item: All Output Data is Encoded (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>