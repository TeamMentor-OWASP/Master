<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="e2f1c054-0081-49c8-8555-f15a02a4bb2f" Author="" Category="Data Access" Priority="2" Rule_Type="Guideline" Status="" Technology="ASP.NET 3.5" title="Encrypt Connection Strings" Topic="Security" phase="Deployment" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Do&lt;/h1&gt;&lt;p&gt;Do not store connection strings in plain text. Use a protected&amp;nbsp;configuration provider such as the RSA Protected Configuration Provider or the Windows Data Protection API (DPAPI)&amp;nbsp;to&amp;nbsp;encrypt connection strings before&amp;nbsp;storing them in configuration files. &lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Connection strings contain sensitive resource access credentials such as user names, passwords and server names. Connection strings stored in plaintext are dangerous, because an attacker that can compromise a server will be able to read those connection strings. Even if a machine is not compromised, connection strings stored in plain text&amp;nbsp;are accessible to administrators and any other users with sufficient privileges&amp;nbsp;on the host machine and/or Windows domain.&amp;nbsp;&lt;/p&gt;&lt;h1&gt;When&lt;/h1&gt;&lt;p&gt;Always encrypt connection strings. The Windows Data Protection API (DPAPI) is the default provider and is&amp;nbsp;an acceptable choice under most circumstances. If&amp;nbsp;an application is deployed&amp;nbsp;within a Web farm environment,&amp;nbsp;the RSA-protected configuration provider is a better choice because it uses asymmetric, public&amp;nbsp;key encryption to encrypt and decrypt data keys that can easily be exported and imported across servers. If neither of these suffice, create a&amp;nbsp;custom provider. &lt;/p&gt;&lt;h1&gt;How&lt;/h1&gt;&lt;p&gt;This section describes how to use DPAPI to encrypt connection strings. Please check the related guidelines for more information on using the RSA Protected Configuration Provider.&amp;nbsp;&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Choose the appropriate configuration provider.&lt;/strong&gt; Under most circumstances DPAPI will suffice, although the RSA protected configuration is the logical choice in web farms where multiple servers are employed. &lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify the configuration sections to be encrypted.&lt;/strong&gt; Encrypting and decrypting data incurs performance overhead. To keep this overhead to a minimum, encrypt only the sections of the configuration file that store sensitive data.&amp;nbsp; Encrypt the &amp;lt;connectionStrings&amp;gt; element of the Web.config file to protect the database connection string. &lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Choose the machine or user store.&lt;/strong&gt; The DataProtectionConfigurationProvider supports machine-level and user-level stores for key storage. The choice of store depends largely on whether or not&amp;nbsp;the application shares a server with other applications and whether or not sensitive data must be kept private for each application.&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Machine Store. &lt;/strong&gt;By default, the DataProtectionConfigurationProvider is configured to use DPAPI with the machine store. Use machine-level key storage in the following situations:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;The application runs on its own dedicated server with no other applications. &lt;/li&gt;&lt;li&gt;Multiple applications run on the same server&amp;nbsp;and&amp;nbsp;those applications need to be able to share sensitive information.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;To encrypt the connectionStrings section&amp;nbsp;with the Machine Store, run the following command from a .NET command prompt:&lt;/p&gt;&lt;pre&gt;   aspnet_regiis -pe "connectionStrings" -app "/MachineDPAPI" -prov "DataProtectionConfigurationProvider" &lt;/pre&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;User Store. &lt;/strong&gt;Use user-level key storage if the application runs in a shared hosting environment and the&amp;nbsp;application's sensitive data should&amp;nbsp;not be accessible to other applications on the server. In this situation, each application should run under a separate identity, and the resources for the application—such as files and databases—should be restricted to that identity.&lt;/p&gt;&lt;p&gt;To encrypt the connectionStrings section&amp;nbsp;with the&amp;nbsp;User Store, run the following command from a .NET command prompt:&lt;/p&gt;&lt;pre&gt;   aspnet_regiis -pe "connectionStrings" -app "/UserDPAPI" -prov "MyUserDataProtectionConfigurationProvider"&lt;/pre&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Encrypt&amp;nbsp;the configuration file data.&lt;/strong&gt;&amp;nbsp;To encrypt the connectionStrings section in Web.config using DPAPI with the Machine Store, run the following command from a .NET command prompt:&lt;/p&gt;&lt;pre&gt;   aspnet_regiis -pe "connectionStrings" -app "/MachineDPAPI" -prov "DataProtectionConfigurationProvider" &lt;/pre&gt;&lt;p&gt;The above command with the -app switch assumes that there is an IIS virtual directory called MachineDPAPI. If the Visual Studio .NET Web server is being utilized instead of IIS, use the -pef switch, which&amp;nbsp;specifies the physical directory location of&amp;nbsp;the configuration file.&lt;/p&gt;&lt;pre&gt;   aspnet_regiis.exe -pef "connectionStrings" C:\Projects\MachineDPAPI -prov "DataProtectionConfigurationProvider"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/pre&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;A web application is running in&amp;nbsp;a hosted web environment. The application uses an SQL database instance and has sensitive data that should not be accessible to&amp;nbsp;other applications on the same system.&amp;nbsp;The web.config file contains a connectionString section that&amp;nbsp;the application uses to access the SQL database:&lt;/p&gt;&lt;pre&gt;&amp;lt;connectionStrings&amp;gt;&lt;br&gt;  &amp;lt;add name="MyLocalSQLServer"&lt;br&gt;        connectionString="Initial Catalog=pubs;User Id=sa;Password=asdasd;&lt;br&gt;       data source=localhost;Integrated Security=SSPI;"&lt;br&gt;       providerName="System.Data.SqlClient"/&amp;gt;&lt;br&gt;&amp;lt;/connectionStrings&amp;gt;&lt;/pre&gt;&lt;p&gt;Unfortunately,&amp;nbsp;anyone capable of reading the web.config file for the application is now able to see the database, the username, and the password for the database instance, and will be able to execute statements at the same level of privilege as the application.&lt;/p&gt;&lt;h1&gt;Solution Example&lt;/h1&gt;&lt;p&gt;A web application is running in&amp;nbsp;a hosted web environment. The application uses an SQL database instance and has sensitive data that should not be accessible to&amp;nbsp;other applications on the same system.&amp;nbsp;The web.config file contains a connectionString section that&amp;nbsp;the application uses to access the SQL database:&lt;/p&gt;&lt;pre&gt;&amp;lt;connectionStrings&amp;gt;&lt;br&gt;  &amp;lt;add name="MyLocalSQLServer"&lt;br&gt;        connectionString="Initial Catalog=pubs;User Id=sa;Password=asdasd;&lt;br&gt;       data source=localhost;Integrated Security=SSPI;"&lt;br&gt;       providerName="System.Data.SqlClient"/&amp;gt;&lt;br&gt;&amp;lt;/connectionStrings&amp;gt;&lt;/pre&gt;&lt;p&gt;During deployment the connectionStrings section of web.config as been encrypted with DataProtectionConfigurationProvider and DPAPI. This was accomplished with the following command:&lt;/p&gt;&lt;pre&gt;   aspnet_regiis -pe "connectionStrings" -app "/UserDPAPI" -prov "MyUserDataProtectionConfigurationProvider"&lt;/pre&gt;&lt;p&gt;The connection string has been encrypted, which can be verified by looking at the web.config file. There is no need to decrypt the file by hand, since ASP.NET handles this transparently.&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Windows Data Protection &lt;a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnsecure/html/windataprotection-dpapi.asp"&gt;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnsecure/html/windataprotection-dpapi.asp&lt;/a&gt; &lt;/li&gt;&lt;li&gt;How to use the ASP.NET utility to encrypt credentials and session state connection strings &lt;a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;329290"&gt;http://support.microsoft.com/default.aspx?scid=kb;en-us;329290&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Items&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:1fe40372-6648-4496-8552-794f91ff6bbf"&gt;Connection Strings are Secured&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:760734bc-7080-4864-91ec-fd6db510f8ed"&gt;Credentials in SQL Connection Strings are Protected in Configuration Files&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:e963466f-3c57-48a5-bdf9-1f66136c12d3"&gt;Use RSA-Protected Configuration Provider in Web Farm Environments&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;p&gt;Adapted from Microsoft patterns &amp;amp; practices guidance. &lt;/p&gt;</content>
</guidanceItem>